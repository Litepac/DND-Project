@page "/customer-dashboard"

@using System.Net.Http.Json
@using System.Globalization
@using System.Linq
@using DNDProject.Web.Models   @* DTO'er: CustomerSummaryDto, CustomerDashboardDto, CustomerTimeseriesPointDto *@
@inject HttpClient Http

<h3>Kunde-dashboard (Stena)</h3>

@if (!string.IsNullOrEmpty(_error))
{
    <div class="alert alert-danger">@_error</div>
}

@if (!string.IsNullOrEmpty(_warning))
{
    <div class="alert alert-warning">@_warning</div>
}

@if (_isLoading && (_customers is null || _customers.Count == 0))
{
    <p>Loading...</p>
}
else
{
    <div class="row">
        <!-- Venstre kolonne: liste over kunder -->
        <div class="col-md-4 border-end">
            <div class="d-flex justify-content-between align-items-start">
                <div>
                    <h5 class="mb-1">Alle kunder</h5>
                    <p class="text-muted mb-2">Klik på en kunde for at se detaljer.</p>
                </div>

                <div style="min-width: 160px;">
                    <label class="form-label mb-0">Periode (måneder)</label>
                    <select class="form-select form-select-sm"
                            @onchange="OnMonthsChanged">
                        <option value="3" selected="@(_months == 3)">3</option>
                        <option value="6" selected="@(_months == 6)">6</option>
                        <option value="12" selected="@(_months == 12)">12</option>
                        <option value="24" selected="@(_months == 24)">24</option>
                    </select>
                </div>
            </div>

            <div class="mb-2">
                <input class="form-control"
                       placeholder="Søg på kundenavn eller nummer..."
                       @bind="_searchText" />
            </div>

            <table class="table table-sm table-hover">
                <thead class="table-light">
                    <tr>
                        <th style="width: 80px;">Kunde</th>
                        <th>Navn</th>
                        <th class="text-end">Total kg</th>
                        <th class="text-end">Modtagelser</th>
                    </tr>
                </thead>
                <tbody>
                    @if (_customers is null || _customers.Count == 0)
                    {
                        <tr>
                            <td colspan="4" class="text-muted">Ingen kunder fundet.</td>
                        </tr>
                    }
                    else
                    {
                        @foreach (var c in FilteredCustomers)
                        {
                            var isSelected = _selectedCustomer?.CustomerKey == c.CustomerKey;
                            var rowClass = isSelected ? "table-primary" : "";

                            <tr class="@rowClass"
                                style="cursor: pointer;"
                                @onclick="@(() => OnCustomerClicked(c))">
                                <td class="fw-semibold">@c.CustomerKey</td>
                                <td>@c.CustomerName</td>
                                <td class="text-end">@FormatKg(c.TotalWeightKg)</td>
                                <td class="text-end">@c.ReceiptCount</td>
                            </tr>
                        }

                        if (!FilteredCustomers.Any())
                        {
                            <tr>
                                <td colspan="4" class="text-muted">Ingen kunder matcher søgningen.</td>
                            </tr>
                        }
                    }
                </tbody>
            </table>

            <div class="text-muted small mt-2">
                Tip: hvis venstre “Total kg” ikke matcher højre periode, så mangler summary-API’et sandsynligvis at filtrere på months.
            </div>
        </div>

        <!-- Højre kolonne: detaljer for valgt kunde -->
        <div class="col-md-8">
            @if (_selectedCustomer is null)
            {
                <p class="text-muted">Vælg en kunde i listen til venstre.</p>
            }
            else if (_details is null)
            {
                @if (_isLoading)
                {
                    <p>Henter detaljer for kunde @_selectedCustomer.CustomerKey...</p>
                }
                else
                {
                    <p class="text-muted">Ingen detaljer at vise.</p>
                }
            }
            else
            {
                var s = _details.Summary;

                // --- KPI beregninger ---
                var avgKgPerReceipt = (s.ReceiptCount > 0) ? (s.TotalWeightKg / s.ReceiptCount) : 0;

                var series = NormalizedTimeseries; // altid _months måneder (med 0'er)
                var latestMonth = series.FirstOrDefault(); // første er nyeste (vi sorterer desc)
                var latestMonthKg = latestMonth?.TotalWeightKg ?? 0;

                var trendPct = ComputeTrendPct(series); // seneste 3 mdr vs forrige 3 mdr
                var trendLabel = trendPct is null
                    ? "—"
                    : $"{trendPct.Value.ToString("N0", CultureInfo.GetCultureInfo("da-DK"))}%";

                <div class="d-flex justify-content-between align-items-start mb-2">
                    <div>
                        <h5 class="mb-1">
                            Detaljer for: @s.CustomerKey
                            @if (!string.IsNullOrWhiteSpace(s.CustomerName))
                            {
                                <span>- @s.CustomerName</span>
                            }
                        </h5>

                        <div class="text-muted small">
                            Periode (data): <strong>@s.FirstDate.ToString("yyyy-MM-dd")</strong>
                            –
                            <strong>@s.LastDate.ToString("yyyy-MM-dd")</strong>
                        </div>

                        <div class="mt-2 d-flex gap-2 flex-wrap">
                            <a class="btn btn-sm btn-outline-secondary" href="/container-efficiency">
                                Åbn tømningsanalyse
                            </a>
                            <a class="btn btn-sm btn-outline-secondary" href="/ml-customers">
                                Åbn ML anbefaling
                            </a>
                        </div>
                    </div>

                    <div class="text-muted small text-end">
                        Viser altid @(_months) måneder (mangler = 0)
                    </div>
                </div>

                <!-- KPI cards -->
                <div class="row g-2 mt-2">
                    <div class="col-md-4">
                        <div class="border rounded p-2">
                            <div class="text-muted small">Total vægt</div>
                            <div class="fw-semibold">@FormatKg(s.TotalWeightKg)</div>
                            <div class="text-muted small">Modtagelser: @s.ReceiptCount</div>
                        </div>
                    </div>

                    <div class="col-md-4">
                        <div class="border rounded p-2">
                            <div class="text-muted small">Gns. kg pr. modtagelse</div>
                            <div class="fw-semibold">@FormatKg(avgKgPerReceipt)</div>
                            <div class="text-muted small">(@s.TotalWeightKg.ToString("N0", CultureInfo.GetCultureInfo("da-DK")) / @s.ReceiptCount)</div>
                        </div>
                    </div>

                    <div class="col-md-4">
                        <div class="border rounded p-2">
                            <div class="text-muted small">Trend (3 mdr)</div>
                            <div class="fw-semibold">@trendLabel</div>
                            <div class="text-muted small">Seneste 3 vs forrige 3</div>
                        </div>
                    </div>
                </div>

                <hr class="my-3" />

                <div class="d-flex justify-content-between align-items-center">
                    <h6 class="mb-0">Udvikling (kg pr. måned)</h6>
                    <div class="text-muted small">Seneste måned: <b>@FormatKg(latestMonthKg)</b></div>
                </div>

                @if (series is null || !series.Any())
                {
                    <p class="text-muted">Ingen vægt-data i den valgte periode.</p>
                }
                else
                {
                    // Find max til skalering af progress bars
                    float maxKg = series.Max(p => p.TotalWeightKg);
                    if (maxKg <= 0) maxKg = 1;

                    <div class="mb-2 mt-2">
                        @foreach (var p in series)
                        {
                            float widthPct = (p.TotalWeightKg / maxKg) * 100f;

                            <div class="mb-1">
                                <div class="d-flex justify-content-between">
                                    <span>@p.Label</span>
                                    <span>@FormatKg(p.TotalWeightKg)</span>
                                </div>

                                <div class="progress" style="height: 12px;">
                                    <div class="progress-bar" role="progressbar"
                                         style="width:@widthPct%;"
                                         aria-valuenow="@p.TotalWeightKg"
                                         aria-valuemin="0"
                                         aria-valuemax="@maxKg">
                                    </div>
                                </div>
                            </div>
                        }
                    </div>
                }
            }
        </div>
    </div>
}

@code {
    private List<CustomerSummaryDto>? _customers;
    private CustomerSummaryDto? _selectedCustomer;
    private CustomerDashboardDto? _details;

    private bool _isLoading = true;
    private string? _error;
    private string? _warning;

    private int _months = 6;
    private string _searchText = string.Empty;

    // Filtreret liste til søgning
    private IEnumerable<CustomerSummaryDto> FilteredCustomers =>
        string.IsNullOrWhiteSpace(_searchText)
            ? _customers ?? Enumerable.Empty<CustomerSummaryDto>()
            : (_customers ?? Enumerable.Empty<CustomerSummaryDto>())
                .Where(c =>
                    (!string.IsNullOrWhiteSpace(c.CustomerName) &&
                     c.CustomerName.Contains(_searchText, StringComparison.OrdinalIgnoreCase))
                    || (!string.IsNullOrWhiteSpace(c.CustomerKey) &&
                        c.CustomerKey.Contains(_searchText, StringComparison.OrdinalIgnoreCase)));

    protected override async Task OnInitializedAsync()
    {
        await LoadSummaries();
    }

    private async Task LoadSummaries()
    {
        _error = null;
        _warning = null;
        _isLoading = true;

        try
        {
            // 1) Først prøver vi at hente summary filtreret på months (bedst)
            //    Hvis endpoint ikke findes, fallback til gammel uden months.
            List<CustomerSummaryDto>? list = null;

            try
            {
                list = await Http.GetFromJsonAsync<List<CustomerSummaryDto>>(
                    $"api/stena/customers/summary?months={_months}");
            }
            catch
            {
                // fallback
                list = await Http.GetFromJsonAsync<List<CustomerSummaryDto>>(
                    "api/stena/customers/summary");

                _warning = "Summary-listen ser ud til ikke at være filtreret på periode endnu (months). " +
                           "Højre side viser korrekt periode – venstre kan vise “all-time”, indtil API’et opdateres.";
            }

            _customers = list;

            if (_customers is not null && _customers.Count > 0)
            {
                // bevar valgt kunde hvis muligt
                var keepKey = _selectedCustomer?.CustomerKey;
                _selectedCustomer = keepKey is not null
                    ? _customers.FirstOrDefault(x => x.CustomerKey == keepKey) ?? _customers[0]
                    : _customers[0];

                await LoadDetails(_selectedCustomer.CustomerKey);
            }
        }
        catch (Exception ex)
        {
            _error = $"Kunne ikke hente kundeliste: {ex.Message}";
        }
        finally
        {
            _isLoading = false;
        }
    }

    private async Task OnCustomerClicked(CustomerSummaryDto customer)
    {
        if (_selectedCustomer?.CustomerKey == customer.CustomerKey)
            return;

        _selectedCustomer = customer;
        await LoadDetails(customer.CustomerKey);
    }

    private async Task LoadDetails(string customerKey)
    {
        _error = null;
        _isLoading = true;

        try
        {
            var requestUri = $"api/stena/customers/{customerKey}/dashboard?months={_months}";
            _details = await Http.GetFromJsonAsync<CustomerDashboardDto>(requestUri);
        }
        catch (Exception ex)
        {
            _error = $"Kunne ikke hente detaljer for kunde {customerKey}: {ex.Message}";
        }
        finally
        {
            _isLoading = false;
        }
    }

    private async Task OnMonthsChanged(ChangeEventArgs e)
    {
        if (!int.TryParse(e.Value?.ToString(), out var m))
            return;

        _months = m;

        // vigtig: months styrer både venstre og højre
        await LoadSummaries();
    }

    // -----------------------------
    // Timeseries normalisering
    // -----------------------------
    private List<CustomerTimeseriesPointDto> NormalizedTimeseries
    {
        get
        {
            var ts = _details?.Timeseries ?? new List<CustomerTimeseriesPointDto>();
            var s = _details?.Summary;

            if (s is null)
                return new List<CustomerTimeseriesPointDto>();

            // Vi vil altid vise _months måneder, sluttende i summary.LastDate’s måned
            var end = new DateTime(s.LastDate.Year, s.LastDate.Month, 1);
            var months = Enumerable.Range(0, _months)
                .Select(i => end.AddMonths(-i))
                .ToList();

            // map eksisterende data på label (yyyy-MM eller hvad I bruger)
            // Vi matcher på "yyyy-MM" for robusthed.
            var map = ts
                .GroupBy(p => NormalizeMonthKey(p.Label))
                .ToDictionary(g => g.Key, g => g.First());

            var result = new List<CustomerTimeseriesPointDto>();

            foreach (var dt in months)
            {
                var key = dt.ToString("yyyy-MM", CultureInfo.InvariantCulture);

                if (map.TryGetValue(key, out var existing))
                {
                    // sørg for label er pæn konsistent
                    result.Add(new CustomerTimeseriesPointDto
                    {
                        Label = key,
                        TotalWeightKg = existing.TotalWeightKg
                    });
                }
                else
                {
                    result.Add(new CustomerTimeseriesPointDto
                    {
                        Label = key,
                        TotalWeightKg = 0
                    });
                }
            }

            return result;
        }
    }

    private static string NormalizeMonthKey(string? label)
    {
        if (string.IsNullOrWhiteSpace(label)) return "";

        label = label.Trim();

        // Hvis label allerede er yyyy-MM, brug den
        if (label.Length >= 7 && label[4] == '-')
            return label.Substring(0, 7);

        // ellers prøv parse (fallback)
        if (DateTime.TryParse(label, out var dt))
            return dt.ToString("yyyy-MM", CultureInfo.InvariantCulture);

        return label;
    }

    private static double? ComputeTrendPct(List<CustomerTimeseriesPointDto> seriesNewestFirst)
    {
        if (seriesNewestFirst is null || seriesNewestFirst.Count < 6)
            return null;

        var last3 = seriesNewestFirst.Take(3).Sum(x => x.TotalWeightKg);
        var prev3 = seriesNewestFirst.Skip(3).Take(3).Sum(x => x.TotalWeightKg);

        if (prev3 <= 0)
        {
            // hvis der var 0 før, kan vi ikke give meningsfuld procent
            return last3 > 0 ? 100 : 0;
        }

        return ((last3 - prev3) / prev3) * 100.0;
    }

    private static string FormatKg(double kg)
        => kg.ToString("N1", CultureInfo.GetCultureInfo("da-DK")) + " kg";

    private static string FormatKg(float kg)
        => kg.ToString("N1", CultureInfo.GetCultureInfo("da-DK")) + " kg";
}
