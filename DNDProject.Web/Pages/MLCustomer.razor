@page "/ml-customer/{CustomerNo}"
@using System.Net.Http.Headers
@using System.Net.Http.Json
@using System.Globalization
@using Microsoft.JSInterop
@inject HttpClient Http
@inject DNDProject.Web.Services.ITokenStorage Tokens
@inject NavigationManager Nav
@inject IJSRuntime JS

<h3 class="mb-2">ML – Anbefaling (@CustomerNo)</h3>

<div class="d-flex gap-2 mb-3">
    <button class="btn btn-outline-secondary" @onclick="Back">← Tilbage</button>
    <button class="btn btn-outline-primary" @onclick="PrintPdf">Print / PDF</button>
    <button class="btn btn-primary" @onclick="Load" disabled="@busy">Genindlæs</button>
</div>

@if (!string.IsNullOrWhiteSpace(error))
{
    <div class="alert alert-danger">@error</div>
}
else if (busy)
{
    <div>Henter...</div>
}
else if (rec is null)
{
    <div class="text-muted">Ingen recommendation fundet.</div>
}
else
{
    var curFill = ExpectedFill(rec.PredKgPerDaySafe, densityKgPerL, Current.FrequencyDays, Current.ContainerL, Current.ContainerCount);
    var propFill = ExpectedFill(rec.PredKgPerDaySafe, densityKgPerL, Proposed.FrequencyDays, Proposed.ContainerL, Proposed.ContainerCount);

    <div class="row g-3">

        <!-- Current -->
        <div class="col-12 col-lg-6">
            <div class="card h-100">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-start">
                        <div>
                            <h5 class="mb-1">Nuværende setup</h5>
                            <div class="text-muted small">@rec.CustomerName (Kundenr: @rec.CustomerNo)</div>
                            @if (current?.LastPickupDate is not null)
                            {
                                <div class="text-muted small">Sidste tømning: @current.LastPickupDate.Value.ToString("yyyy-MM-dd")</div>
                            }
                        </div>
                    </div>

                    <hr />

                    <div class="row g-2">
                        <div class="col-6">
                            <label class="form-label">Container størrelse</label>
                            <select class="form-select" @bind="Current.ContainerL">
                                @foreach (var s in AllowedLiters)
                                {
                                    <option value="@s">@s L</option>
                                }
                            </select>
                        </div>

                        <div class="col-6">
                            <label class="form-label">Antal containere</label>
                            <select class="form-select" @bind="Current.ContainerCount">
                                @foreach (var n in AllowedCounts)
                                {
                                    <option value="@n">@n</option>
                                }
                            </select>
                        </div>

                        <div class="col-12">
                            <label class="form-label">Frekvens (dage)</label>
                            <select class="form-select" @bind="Current.FrequencyDays">
                                @foreach (var f in AllowedFrequencies)
                                {
                                    <option value="@f">Hver @f dage</option>
                                }
                            </select>
                        </div>
                    </div>

                    <hr />

                    <div class="small">
                        <div class="d-flex justify-content-between">
                            <span class="text-muted">Est. fill ved tømning</span>
                            <b>@curFill.ToString("P0", CultureInfo.InvariantCulture)</b>
                        </div>
                        <div class="d-flex justify-content-between">
                            <span class="text-muted">Ture/år (est.)</span>
                            <b>@TripsPerYear(Current.FrequencyDays).ToString("N0")</b>
                        </div>
                        <div class="d-flex justify-content-between">
                            <span class="text-muted">Pred kg/dag (safe)</span>
                            <b>@rec.PredKgPerDaySafe.ToString("N0")</b>
                        </div>
                    </div>

                    <div class="text-muted small mt-2">
                        *Nuværende setup* forsøges hentet fra DB (best-effort). Hvis ikke endpoint findes, bruges ML som fallback.
                    </div>
                </div>
            </div>
        </div>

        <!-- Proposed (ML + dropdowns) -->
        <div class="col-12 col-lg-6">
            <div class="card h-100 border-primary">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-start">
                        <div>
                            <h5 class="mb-1">Anbefalet setup (ML)</h5>
                            <div class="text-muted small">Starter på ML – kan justeres</div>
                        </div>
                        <button class="btn btn-sm btn-outline-primary" @onclick="ResetProposedToMl">
                            Reset til ML
                        </button>
                    </div>

                    <hr />

                    <div class="row g-2">
                        <div class="col-6">
                            <label class="form-label">Container størrelse</label>
                            <select class="form-select" @bind="Proposed.ContainerL">
                                @foreach (var s in AllowedLiters)
                                {
                                    <option value="@s">@s L</option>
                                }
                            </select>
                        </div>

                        <div class="col-6">
                            <label class="form-label">Antal containere</label>
                            <select class="form-select" @bind="Proposed.ContainerCount">
                                @foreach (var n in AllowedCounts)
                                {
                                    <option value="@n">@n</option>
                                }
                            </select>
                        </div>

                        <div class="col-12">
                            <label class="form-label">Frekvens (dage)</label>
                            <select class="form-select" @bind="Proposed.FrequencyDays">
                                @foreach (var f in AllowedFrequencies)
                                {
                                    <option value="@f">Hver @f dage</option>
                                }
                            </select>
                        </div>
                    </div>

                    <hr />

                    <div class="small">
                        <div class="d-flex justify-content-between">
                            <span class="text-muted">Est. fill ved tømning</span>
                            <b>@propFill.ToString("P0", CultureInfo.InvariantCulture)</b>
                        </div>
                        <div class="d-flex justify-content-between">
                            <span class="text-muted">Ture/år (est.)</span>
                            <b>@TripsPerYear(Proposed.FrequencyDays).ToString("N0")</b>
                        </div>
                        <div class="d-flex justify-content-between">
                            <span class="text-muted">ML default</span>
                            <b>@($"{rec.ContainerCount} × {rec.ContainerL} L • hver {rec.FrequencyDays} dage")</b>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Savings -->
        <div class="col-12">
            <div class="card shadow-sm">
                <div class="card-body">
                    <h5 class="mb-1">Besparelse (nuværende → valgt setup)</h5>
                    <div class="text-muted small mb-3">
                        Estimat baseret på antagelserne nedenfor.
                    </div>

                    <div class="row g-3 mb-3">
                        <div class="col-md-4">
                            <label class="form-label">Km pr. tur (antagelse)</label>
                            <input class="form-control" type="number" step="1" @bind="kmPerTrip" />
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">CO₂ pr. km (kg/km)</label>
                            <input class="form-control" type="number" step="0.1" @bind="co2PerKm" />
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">Omkostning pr. tur (kr)</label>
                            <input class="form-control" type="number" step="1" @bind="costPerTrip" />
                        </div>
                    </div>

                    <div class="row g-3">
                        <div class="col-md-4">
                            <div class="p-3 border rounded">
                                <div class="text-muted small">Potentiale: færre ture/år</div>
                                <div class="fw-bold">@TripsSavedPerYear.ToString("N0")</div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="p-3 border rounded">
                                <div class="text-muted small">Potentiale CO₂/år</div>
                                <div class="fw-bold">@Co2SavedYear.ToString("N0") kg</div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="p-3 border rounded">
                                <div class="text-muted small">Potentiale kr/år</div>
                                <div class="fw-bold">@CostSavedYear.ToString("N0") kr</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Baseline (optional) -->
        @if (baseline is not null && baseline.TripDays > 0)
        {
            <div class="col-12">
                <div class="card mt-0">
                    <div class="card-body">
                        <h6 class="mb-2">Baseline nøgletal (historisk)</h6>
                        <div class="row">
                            <div class="col-md-4">
                                <div class="text-muted small">Tømmedage i perioden</div>
                                <div><b>@baseline.TripDays</b></div>
                            </div>
                            <div class="col-md-4">
                                <div class="text-muted small">Total kg (rest) i perioden</div>
                                <div><b>@baseline.TotalKg.ToString("N0")</b></div>
                            </div>
                            <div class="col-md-4">
                                <div class="text-muted small">Kg pr. “tømmedag” (proxy)</div>
                                <div><b>@baseline.AvgKgPerTrip.ToString("N0")</b></div>
                            </div>
                        </div>
                        <div class="text-muted small mt-2">
                            Baseline er et “proxy” baseret på registrerede modtagelseslinjer pr. dato (ikke kontrakt/faktisk stop-tælling).
                        </div>
                    </div>
                </div>
            </div>
        }
    </div>
}

@code {
    [Parameter] public string CustomerNo { get; set; } = "";

    DateTime from = new(2024, 1, 1);
    DateTime to = new(2024, 12, 31);

    bool busy;
    string? error;

    RecommendationDto? rec;
    BaselineDto? baseline;

    // "current setup" fra API (best-effort)
    CurrentSetupDto? current;

    // Antagelser (UI)
    double kmPerTrip = 20;
    double co2PerKm = 1.2;     // kg CO2 pr km
    double costPerTrip = 500;  // kr pr tur

    // Volumen antagelse
    const double densityKgPerL = 0.13;

    // Dropdown options
    static readonly int[] AllowedLiters = { 120, 240, 660, 1100 };
    static readonly int[] AllowedFrequencies = { 3, 7, 10, 14, 21, 28, 35, 42, 56 };
    static IEnumerable<int> AllowedCounts => Enumerable.Range(1, 20);

    private bool _setupsInitialized = false;
    private string? _lastCustomerNo;

    // UI setups
    class Setup
    {
        public int ContainerL { get; set; } = 1100;
        public int ContainerCount { get; set; } = 1;
        public int FrequencyDays { get; set; } = 14;
    }

    Setup Current { get; set; } = new();
    Setup Proposed { get; set; } = new();

    public sealed record RecommendationDto(
        string CustomerNo,
        string CustomerName,
        int ContainerL,
        int ContainerCount,
        int FrequencyDays,
        double ExpectedFill,
        double PredKgPerDaySafe
    );

    public sealed record BaselineDto(
        string CustomerNo,
        string CustomerName,
        DateTime From,
        DateTime To,
        int PeriodDays,
        int TripDays,
        double TotalKg,
        double TripsPerYear,
        double AvgKgPerTrip,
        double AvgKgPerDayCalendar,
        double AvgKgPerDayOnTripDays
    );

    public sealed record CurrentSetupDto(
        int ContainerL,
        int ContainerCount,
        int FrequencyDays,
        DateTime? LastPickupDate
    );

    protected override async Task OnParametersSetAsync()
    {
        // hvis du skifter customer, så re-init dropdowns
        if (!string.Equals(_lastCustomerNo, CustomerNo, StringComparison.OrdinalIgnoreCase))
        {
            _setupsInitialized = false;
            _lastCustomerNo = CustomerNo;
        }

        await Load();
    }

    async Task Load()
    {
        busy = true;
        error = null;
        rec = null;
        baseline = null;
        current = null;

        try
        {
            var token = await Tokens.GetAsync();
            if (string.IsNullOrWhiteSpace(token))
            {
                error = "Du er ikke logget ind (mangler token).";
                return;
            }

            Http.DefaultRequestHeaders.Authorization = new AuthenticationHeaderValue("Bearer", token);

            var recUrl =
                $"api/ml/recommend-one?from={from:yyyy-MM-dd}&to={to:yyyy-MM-dd}&customerNo={Uri.EscapeDataString(CustomerNo)}";

            var baseUrl =
                $"api/ml/baseline?from={from:yyyy-MM-dd}&to={to:yyyy-MM-dd}&customerNo={Uri.EscapeDataString(CustomerNo)}";

            var currentUrl =
                $"api/ml/current-setup?from={from:yyyy-MM-dd}&to={to:yyyy-MM-dd}&customerNo={Uri.EscapeDataString(CustomerNo)}";

            // 1) Recommendation
            var recResp = await Http.GetAsync(recUrl);

            if (recResp.StatusCode == System.Net.HttpStatusCode.NotFound)
            {
                error = "Ingen recommendation fundet (404).";
                return;
            }
            if (!recResp.IsSuccessStatusCode)
            {
                error = $"Kunne ikke hente recommendation ({(int)recResp.StatusCode})";
                return;
            }

            rec = await recResp.Content.ReadFromJsonAsync<RecommendationDto>();
            if (rec is null)
            {
                error = "Kunne ikke læse recommendation fra serveren.";
                return;
            }

            // 2) Current setup (best-effort)
            try
            {
                var curResp = await Http.GetAsync(currentUrl);
                if (curResp.IsSuccessStatusCode)
                {
                    current = await curResp.Content.ReadFromJsonAsync<CurrentSetupDto>();
                }
            }
            catch
            {
                // ignore
            }

            // 3) Init dropdowns én gang (ellers overskriver du brugerens valg)
            if (!_setupsInitialized)
            {
                InitSetupsFromRec();
                _setupsInitialized = true;
            }

            // 4) Baseline (nice to have)
            var baseResp = await Http.GetAsync(baseUrl);
            if (baseResp.IsSuccessStatusCode)
            {
                baseline = await baseResp.Content.ReadFromJsonAsync<BaselineDto>();
            }
        }
        catch (Exception ex)
        {
            error = ex.Message;
        }
        finally
        {
            busy = false;
        }
    }

    static int NormLiters(int liters) => AllowedLiters.Contains(liters) ? liters : 660;
    static int NormCount(int n) => Math.Clamp(n, 1, 30);
    static int NormFreq(int d) => Math.Clamp(d, 1, 90);

    void InitSetupsFromRec()
    {
        if (rec is null) return;

        // Proposed starter på ML
        Proposed.ContainerL = NormLiters(rec.ContainerL);
        Proposed.ContainerCount = NormCount(rec.ContainerCount);
        Proposed.FrequencyDays = NormFreq(rec.FrequencyDays);

        // Current fra DB hvis muligt, ellers fallback til ML
        if (current is not null)
        {
            Current.ContainerL = NormLiters(current.ContainerL);
            Current.ContainerCount = NormCount(current.ContainerCount);
            Current.FrequencyDays = NormFreq(current.FrequencyDays);
        }
        else
        {
            Current.ContainerL = Proposed.ContainerL;
            Current.ContainerCount = Proposed.ContainerCount;
            Current.FrequencyDays = Proposed.FrequencyDays;
        }
    }

    void ResetProposedToMl()
    {
        if (rec is null) return;
        Proposed.ContainerL = NormLiters(rec.ContainerL);
        Proposed.ContainerCount = NormCount(rec.ContainerCount);
        Proposed.FrequencyDays = NormFreq(rec.FrequencyDays);
    }

    static double TripsPerYear(int frequencyDays)
    {
        frequencyDays = Math.Max(1, frequencyDays);
        return 365.0 / frequencyDays;
    }

    static double ExpectedFill(double kgPerDay, double densityKgPerLiter, int frequencyDays, int containerSizeLiters, int containerCount)
    {
        kgPerDay = Math.Max(0, kgPerDay);
        densityKgPerLiter = densityKgPerLiter > 0 ? densityKgPerLiter : 0.13;
        frequencyDays = Math.Max(1, frequencyDays);
        containerSizeLiters = Math.Max(1, containerSizeLiters);
        containerCount = Math.Max(1, containerCount);

        double litersPerDay = kgPerDay / densityKgPerLiter;
        double litersPerEmptyTotal = litersPerDay * frequencyDays;
        double totalCapacityLiters = containerCount * (double)containerSizeLiters;

        return totalCapacityLiters <= 0 ? 0 : (litersPerEmptyTotal / totalCapacityLiters);
    }

    double CurrentTripsPerYear => TripsPerYear(Current.FrequencyDays);
    double ProposedTripsPerYear => TripsPerYear(Proposed.FrequencyDays);

    double TripsSavedPerYear => Math.Max(0, CurrentTripsPerYear - ProposedTripsPerYear);
    double Co2SavedYear => TripsSavedPerYear * kmPerTrip * co2PerKm;
    double CostSavedYear => TripsSavedPerYear * costPerTrip;

    async Task PrintPdf() => await JS.InvokeVoidAsync("window.print");

    void Back() => Nav.NavigateTo("/ml-customers");
}
