@page "/ml-customer/{CustomerNo}"
@using System.Net.Http.Headers
@using System.Net.Http.Json
@using DNDProject.Web.Models
@inject HttpClient Http
@inject DNDProject.Web.Services.ITokenStorage Tokens
@inject NavigationManager Nav
@inject IJSRuntime JS

<h3>ML – Anbefaling (@CustomerNo)</h3>

<button class="btn btn-link p-0 mb-3" @onclick="Back">← Tilbage</button>

@if (!string.IsNullOrWhiteSpace(error))
{
    <div class="alert alert-danger">@error</div>
}
else if (busy)
{
    <div>Henter...</div>
}
else if (rec is not null)
{
    // live-beregninger pr. render (så dropdowns opdaterer med det samme)
    var currentFill = ExpectedFill(rec.PredKgPerDaySafe, DefaultDensityKgPerL, Current.FrequencyDays, Current.ContainerL, Current.ContainerCount);
    var proposedFill = ExpectedFill(rec.PredKgPerDaySafe, DefaultDensityKgPerL, Proposed.FrequencyDays, Proposed.ContainerL, Proposed.ContainerCount);

    var currentTrips = TripsPerYear(Current.FrequencyDays);
    var proposedTrips = TripsPerYear(Proposed.FrequencyDays);

    var tripsSavedRaw = currentTrips - proposedTrips;
    var currentCo2 = currentTrips * kmPerTrip * co2PerKm;
    var proposedCo2 = proposedTrips * kmPerTrip * co2PerKm;
    var co2SavedRaw = currentCo2 - proposedCo2;

    var currentCost = currentTrips * costPerTrip;
    var proposedCost = proposedTrips * costPerTrip;
    var costSavedRaw = currentCost - proposedCost;

    var outOfScope = (Proposed.ContainerL == 1100 && Proposed.ContainerCount >= 15);

    string TripsLabel() => tripsSavedRaw >= 0 ? "Potentiale: færre ture/år" : "Flere ture/år";
    string Co2Label() => co2SavedRaw >= 0 ? "Potentiale CO₂/år" : "Mere CO₂/år";
    string CostLabel() => costSavedRaw >= 0 ? "Potentiale kr/år" : "Mere kr/år";

    <div style="max-width: 1100px;">

        <div class="d-flex gap-2 mb-3">
            <button class="btn btn-outline-secondary" @onclick="Back">← Tilbage</button>
            <button class="btn btn-outline-primary" @onclick="PrintPdf">Print / PDF</button>
            <button class="btn btn-primary" @onclick="Load">Genindlæs</button>
        </div>

        <!-- TOP: NUVÆRENDE vs ANBEFALET -->
        <div class="row g-3 mb-3">

            <!-- NUVÆRENDE (READ-ONLY, fra DB/tømningsanalyse) -->
            <div class="col-12 col-lg-6">
                <div class="card h-100">
                    <div class="card-body">
                        <h5 class="card-title mb-1">Nuværende setup</h5>
                        <div class="text-muted mb-2">@rec.CustomerName (Kundenr: @rec.CustomerNo)</div>

                        @if (_currentFromDb && currentSetup?.LastPickupDate is not null)
                        {
                            <div class="text-muted small mb-3">
                                Kilde: historik (seneste tømning: @currentSetup.LastPickupDate.Value.ToString("yyyy-MM-dd"))
                            </div>
                        }
                        else
                        {
                            <div class="text-muted small mb-3">
                                Kilde: historik ikke fundet i perioden — fallback til ML-værdier.
                            </div>
                        }

                        <div class="row g-2">
                            <div class="col-6">
                                <label class="form-label">Container størrelse</label>
                                <input class="form-control" value="@($"{Current.ContainerL} L")" readonly />
                            </div>

                            <div class="col-6">
                                <label class="form-label">Antal containere</label>
                                <input class="form-control" value="@Current.ContainerCount" readonly />
                            </div>

                            <div class="col-12">
                                <label class="form-label">Frekvens (dage)</label>
                                <input class="form-control" value="@($"Hver {Current.FrequencyDays} dage")" readonly />
                            </div>
                        </div>

                        <hr />

                        <dl class="row mb-0">
                            <dt class="col-sm-6">Est. fill ved tømning</dt>
                            <dd class="col-sm-6">@currentFill.ToString("P0")</dd>

                            <dt class="col-sm-6">Ture/år (est.)</dt>
                            <dd class="col-sm-6">@currentTrips.ToString("N0")</dd>

                            <dt class="col-sm-6">Pred kg/dag (safe)</dt>
                            <dd class="col-sm-6">@rec.PredKgPerDaySafe.ToString("N0")</dd>
                        </dl>
                    </div>
                </div>
            </div>

            <!-- ANBEFALET -->
            <div class="col-12 col-lg-6">
                <div class="card h-100 border-primary">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-start">
                            <div>
                                <h5 class="card-title mb-1">Anbefalet setup (ML)</h5>
                                <div class="text-muted">Starter på ML – kan justeres</div>
                            </div>

                            <button class="btn btn-sm btn-outline-primary" @onclick="ResetProposedToMl">
                                Reset til ML
                            </button>
                        </div>

                        <div class="row g-2 mt-2">
                            <div class="col-6">
                                <label class="form-label">Container størrelse</label>
                                <select class="form-select" @bind="Proposed.ContainerL">
                                    @foreach (var s in AllowedSizes)
                                    {
                                        <option value="@s">@s L</option>
                                    }
                                </select>
                            </div>

                            <div class="col-6">
                                <label class="form-label">Antal containere</label>
                                <select class="form-select" @bind="Proposed.ContainerCount">
                                    @for (int i = 1; i <= 30; i++)
                                    {
                                        <option value="@i">@i</option>
                                    }
                                </select>
                            </div>

                            <div class="col-12">
                                <label class="form-label">Frekvens (dage)</label>
                                <select class="form-select" @bind="Proposed.FrequencyDays">
                                    @foreach (var d in AllowedFrequencies)
                                    {
                                        <option value="@d">Hver @d dage</option>
                                    }
                                </select>
                            </div>
                        </div>

                        <hr />

                        <dl class="row mb-0">
                            <dt class="col-sm-6">Est. fill ved tømning</dt>
                            <dd class="col-sm-6">@proposedFill.ToString("P0")</dd>

                            <dt class="col-sm-6">Ture/år (est.)</dt>
                            <dd class="col-sm-6">@proposedTrips.ToString("N0")</dd>

                            <dt class="col-sm-6">ML default</dt>
                            <dd class="col-sm-6">@rec.ContainerCount × @rec.ContainerL L • hver @rec.FrequencyDays dage</dd>
                        </dl>

                        @if (outOfScope)
                        {
                            <div class="alert alert-warning mt-3 mb-0">
                                Setup virker uden for “små beholdere”-scope (fx 15 × 1100L).
                                Overvej en anden løsning (komprimator/skip/storkunde-løsning).
                            </div>
                        }
                    </div>
                </div>
            </div>

        </div>

        <!-- RUBRIK: BESPARELSE -->
        <div class="card mb-3">
            <div class="card-body">
                <h5 class="mb-1">Besparelse (nuværende → valgt setup)</h5>
                <div class="text-muted mb-3">Estimat baseret på antagelserne nedenfor.</div>

                <div class="row g-3 mb-3">
                    <div class="col-md-4">
                        <label class="form-label">Km pr. tur (antagelse)</label>
                        <input class="form-control" type="number" step="1" @bind="kmPerTrip" />
                    </div>
                    <div class="col-md-4">
                        <label class="form-label">CO₂ pr. km (kg/km)</label>
                        <input class="form-control" type="number" step="0.1" @bind="co2PerKm" />
                    </div>
                    <div class="col-md-4">
                        <label class="form-label">Omkostning pr. tur (kr)</label>
                        <input class="form-control" type="number" step="1" @bind="costPerTrip" />
                    </div>
                </div>

                <div class="row g-3">
                    <div class="col-md-4">
                        <div class="border rounded p-3">
                            <div class="text-muted small">@TripsLabel()</div>
                            <div class="fs-5 fw-semibold">@Math.Abs(tripsSavedRaw).ToString("N0")</div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="border rounded p-3">
                            <div class="text-muted small">@Co2Label()</div>
                            <div class="fs-5 fw-semibold">@Math.Abs(co2SavedRaw).ToString("N0") kg</div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="border rounded p-3">
                            <div class="text-muted small">@CostLabel()</div>
                            <div class="fs-5 fw-semibold">@Math.Abs(costSavedRaw).ToString("N0") kr</div>
                        </div>
                    </div>
                </div>

            </div>
        </div>

    </div>
}
else
{
    <div>Ingen recommendation fundet.</div>
}

@code {
    [Parameter] public string CustomerNo { get; set; } = "";

    DateTime from = new(2024, 1, 1);
    DateTime to = new(2024, 12, 31);

    bool busy;
    string? error;

    RecommendationDto? rec;
    BaselineDto? baseline;

    // Antagelser (UI)
    double kmPerTrip = 20;
    double co2PerKm = 1.2;     // kg CO2 pr km
    double costPerTrip = 500;  // kr pr tur

    // Densitet antagelse (undgå navne-konflikter)
    const double DefaultDensityKgPerL = 0.13;

    // -------------------------
    // DTOs
    // -------------------------
    public sealed record RecommendationDto(
        string CustomerNo,
        string CustomerName,
        int ContainerL,
        int ContainerCount,
        int FrequencyDays,
        double ExpectedFill,
        double PredKgPerDaySafe
    );

    public sealed record BaselineDto(
        string CustomerNo,
        string CustomerName,
        DateTime From,
        DateTime To,
        int PeriodDays,
        int TripDays,
        double TotalKg,
        double TripsPerYear,
        double AvgKgPerTrip,
        double AvgKgPerDayCalendar,
        double AvgKgPerDayOnTripDays
    );

    // “Current setup” beregnet ud fra tømningsanalysen
    public sealed record CurrentSetupDto(
        int ContainerL,
        int ContainerCount,
        int FrequencyDays,
        DateTime? LastPickupDate
    );

    CurrentSetupDto? currentSetup;
    bool _currentFromDb = false;

    // UI state: undgå at overskrive brugerens dropdown valg ved reload
    private bool _setupsInitialized = false;
    private string? _initCustomerNo;

    protected override async Task OnParametersSetAsync()
    {
        if (!string.Equals(_initCustomerNo, CustomerNo, StringComparison.OrdinalIgnoreCase))
        {
            _setupsInitialized = false;
            _initCustomerNo = CustomerNo;
        }

        await Load();
    }

    async Task Load()
    {
        busy = true;
        error = null;
        rec = null;
        baseline = null;
        currentSetup = null;
        _currentFromDb = false;

        try
        {
            var token = await Tokens.GetAsync();
            if (string.IsNullOrWhiteSpace(token))
            {
                error = "Du er ikke logget ind (mangler token).";
                return;
            }

            Http.DefaultRequestHeaders.Authorization =
                new AuthenticationHeaderValue("Bearer", token);

            var recUrl =
                $"api/ml/recommend-one?from={from:yyyy-MM-dd}&to={to:yyyy-MM-dd}&customerNo={Uri.EscapeDataString(CustomerNo)}";

            var baseUrl =
                $"api/ml/baseline?from={from:yyyy-MM-dd}&to={to:yyyy-MM-dd}&customerNo={Uri.EscapeDataString(CustomerNo)}";

            // 1) Hent recommendation
            var recResp = await Http.GetAsync(recUrl);

            if (recResp.StatusCode == System.Net.HttpStatusCode.NotFound)
            {
                error = "Ingen recommendation fundet (404).";
                return;
            }
            if (!recResp.IsSuccessStatusCode)
            {
                error = $"Kunne ikke hente recommendation ({(int)recResp.StatusCode})";
                return;
            }

            rec = await recResp.Content.ReadFromJsonAsync<RecommendationDto>();
            if (rec is null)
            {
                error = "Kunne ikke læse recommendation fra serveren.";
                return;
            }

            // 2) Hent current setup via tømningsanalyse (DB)
            if (int.TryParse(CustomerNo, out var customerKey))
            {
                currentSetup = await LoadCurrentSetupFromEfficiencyAsync(customerKey);
                _currentFromDb = currentSetup is not null;
            }

            // 3) Init dropdowns ÉN gang (ellers overskriver du brugerens valg ved hver Load)
            if (!_setupsInitialized)
            {
                InitSetupsFromRec();
                _setupsInitialized = true;
            }

            // 4) Baseline (nice to have)
            var baseResp = await Http.GetAsync(baseUrl);
            if (baseResp.IsSuccessStatusCode)
            {
                baseline = await baseResp.Content.ReadFromJsonAsync<BaselineDto>();
            }
        }
        catch (Exception ex)
        {
            error = ex.Message;
        }
        finally
        {
            busy = false;
        }
    }

    // Henter “nuværende setup” via de samme endpoints som tømningsanalysen bruger
    async Task<CurrentSetupDto?> LoadCurrentSetupFromEfficiencyAsync(int customerKey)
    {
        // Brug “seneste historik” (fx 24 mdr) så vi kan finde last pickup + interval
        const int months = 24;
        const int thresholdPct = 80;

        async Task<ContainerEfficiencyCustomerDetailDto?> GetDetail(int liters)
        {
            var url = $"api/stena/efficiency/customer/{customerKey}?months={months}&thresholdPct={thresholdPct}&liters={liters}";
            var resp = await Http.GetAsync(url);
            if (!resp.IsSuccessStatusCode) return null;
            return await resp.Content.ReadFromJsonAsync<ContainerEfficiencyCustomerDetailDto>();
        }

        // Kør i parallel (4 kald)
        var tasks = AllowedSizes.Select(GetDetail).ToArray();
        var results = await Task.WhenAll(tasks);

        var candidates = results
            .Where(d => d?.Empties is not null && d.Empties.Count > 0)
            .Select(d => new
            {
                Detail = d!,
                Last = d!.Empties.Max(e => e.Date).Date
            })
            .OrderByDescending(x => x.Last)
            .ToList();

        if (candidates.Count == 0) return null;

        var best = candidates[0].Detail;
        var empties = best.Empties;

        var lastDate = empties.Max(e => e.Date).Date;

        // Hvor mange “tømninger” på seneste dag (proxy for antal containere)
        var countOnLast = empties.Count(e => e.Date.Date == lastDate);

        // Frequency: tag seneste pickup-dage og beregn gennemsnitlig afstand
        var pickupDays = empties
            .Select(e => e.Date.Date)
            .Distinct()
            .OrderByDescending(d => d)
            .Take(6)
            .OrderBy(d => d)
            .ToList();

        var freq = 14; // fallback
        if (pickupDays.Count >= 2)
        {
            var diffs = new List<double>();
            for (int i = 1; i < pickupDays.Count; i++)
            {
                diffs.Add((pickupDays[i] - pickupDays[i - 1]).TotalDays);
            }

            var avg = diffs.Count == 0 ? 14 : diffs.Average();
            freq = Math.Max(1, (int)Math.Round(avg));
        }

        return new CurrentSetupDto(
            ContainerL: best.Liters,
            ContainerCount: Math.Max(1, countOnLast),
            FrequencyDays: freq,
            LastPickupDate: lastDate
        );
    }

    async Task PrintPdf() => await JS.InvokeVoidAsync("window.print");
    void Back() => Nav.NavigateTo("/ml-customers");

    // -------------------------
    // Setup state
    // -------------------------
    class Setup
    {
        public int ContainerL { get; set; } = 1100;
        public int ContainerCount { get; set; } = 1;
        public int FrequencyDays { get; set; } = 14;
    }

    Setup Current { get; set; } = new();
    Setup Proposed { get; set; } = new();

    static readonly int[] AllowedSizes = { 120, 240, 660, 1100 };
    static readonly int[] AllowedFrequencies = { 3, 7, 10, 14, 21, 28, 35, 42, 56 };

    static int NormLiters(int liters) => AllowedSizes.Contains(liters) ? liters : 660;
    static int NormCount(int n) => Math.Clamp(n, 1, 30);
    static int NormFreq(int d) => Math.Clamp(d, 1, 90);

    void InitSetupsFromRec()
    {
        if (rec is null) return;

        // Proposed starter altid på ML
        Proposed.ContainerL = NormLiters(rec.ContainerL);
        Proposed.ContainerCount = NormCount(rec.ContainerCount);
        Proposed.FrequencyDays = NormFreq(rec.FrequencyDays);

        // Current kommer fra DB/tømningsanalyse hvis muligt
        if (currentSetup is not null)
        {
            Current.ContainerL = NormLiters(currentSetup.ContainerL);
            Current.ContainerCount = NormCount(currentSetup.ContainerCount);
            Current.FrequencyDays = NormFreq(currentSetup.FrequencyDays);
        }
        else
        {
            // fallback (hvis historik ikke findes)
            Current.ContainerL = Proposed.ContainerL;
            Current.ContainerCount = Proposed.ContainerCount;
            Current.FrequencyDays = Proposed.FrequencyDays;
        }
    }

    void ResetProposedToMl()
    {
        if (rec is null) return;
        Proposed.ContainerL = NormLiters(rec.ContainerL);
        Proposed.ContainerCount = NormCount(rec.ContainerCount);
        Proposed.FrequencyDays = NormFreq(rec.FrequencyDays);
    }

    static double TripsPerYear(int frequencyDays)
    {
        frequencyDays = Math.Max(1, frequencyDays);
        return 365.0 / frequencyDays;
    }

    static double ExpectedFill(double kgPerDay, double densityKgPerLiter, int frequencyDays, int containerSizeLiters, int containerCount)
    {
        kgPerDay = Math.Max(0, kgPerDay);
        densityKgPerLiter = densityKgPerLiter > 0 ? densityKgPerLiter : DefaultDensityKgPerL;
        frequencyDays = Math.Max(1, frequencyDays);
        containerSizeLiters = Math.Max(1, containerSizeLiters);
        containerCount = Math.Max(1, containerCount);

        double litersPerDay = kgPerDay / densityKgPerLiter;
        double litersPerEmptyTotal = litersPerDay * frequencyDays;
        double totalCapacityLiters = containerCount * (double)containerSizeLiters;

        return totalCapacityLiters <= 0 ? 0 : (litersPerEmptyTotal / totalCapacityLiters);
    }
}
