@page "/ml-customer/{CustomerNo}"
@using System.Net.Http.Headers
@using System.Net.Http.Json
@using DNDProject.Web.Components
@inject HttpClient Http
@inject DNDProject.Web.Services.ITokenStorage Tokens
@inject NavigationManager Nav
@inject IJSRuntime JS


<h3>ML – Anbefaling (@CustomerNo)</h3>

<button class="btn btn-link p-0 mb-3" @onclick="Back">← Tilbage</button>

@if (!string.IsNullOrWhiteSpace(error))
{
    <div class="alert alert-danger">@error</div>
}
else if (busy)
{
    <div>Henter...</div>
}
else if (rec is not null)
{
    <div style="max-width:920px;">
        @{
            var (outOfScope, outMsg) = IsOutOfScope(rec);
        }

        @if (outOfScope)
        {
            <div class="alert alert-warning">
                <b>Uden for små-container modellen</b><br />
                @outMsg<br />
                <span class="text-muted">
                    Brug i stedet en “stor-container/komprimator” model eller manuel vurdering.
                </span>
            </div>
        }

        <!-- TOP: ML recommendation + manual calculator side by side -->
        <div class="row g-3 mb-3">
            <div class="col-12 col-lg-6">
                <div class="card h-100">
                    <div class="card-body">
                        <h5 class="card-title mb-1">@rec.CustomerName</h5>
                        <div class="text-muted mb-3">Kundenr: @rec.CustomerNo</div>

                        <dl class="row mb-0">
                            <dt class="col-sm-4">Container</dt>
                            <dd class="col-sm-8">@rec.ContainerCount × @rec.ContainerL L</dd>

                            <dt class="col-sm-4">Frekvens</dt>
                            <dd class="col-sm-8">Hver @rec.FrequencyDays dage</dd>

                            <dt class="col-sm-4">Expected fill</dt>
                            <dd class="col-sm-8">@rec.ExpectedFill.ToString("P0")</dd>

                            <dt class="col-sm-4">Pred kg/dag (safe)</dt>
                            <dd class="col-sm-8">@rec.PredKgPerDaySafe.ToString("N0")</dd>
                        </dl>

                        <hr />

                        <div class="small text-muted">
                            <div><b>Container</b>: foreslået antal × nominelt volumen (L) for restaffald.</div>
                            <div><b>Frekvens</b>: foreslået antal dage mellem tømninger.</div>
                            <div><b>Expected fill</b>: estimeret fyldningsgrad ved tømning (volumen-baseret antagelse).</div>
                            <div><b>Pred kg/dag (safe)</b>: konservativt estimat for gennemsnitlig kg pr. dag baseret på historik/model.</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Business + ESG -->
        <div class="card mb-3">
            <div class="card-body">
                <h5 class="mb-1">Business & ESG impact (før / efter)</h5>
                <div class="text-muted mb-3">
                    Viser baseline (historisk) vs anbefalet. Tallene afhænger af antagelserne (kan justeres).
                </div>

                <div class="row g-3 mb-3">
                    <div class="col-md-4">
                        <label class="form-label">Km pr. tur (antagelse)</label>
                        <input class="form-control" type="number" step="1" @bind="kmPerTrip" />
                        <div class="form-text">Brug fx gennemsnitlig rute tur/retur.</div>
                    </div>
                    <div class="col-md-4">
                        <label class="form-label">CO₂ pr. km (kg/km)</label>
                        <input class="form-control" type="number" step="0.1" @bind="co2PerKm" />
                        <div class="form-text">Afhænger af biltype/last. Brug et konservativt tal.</div>
                    </div>
                    <div class="col-md-4">
                        <label class="form-label">Omkostning pr. tur (kr)</label>
                        <input class="form-control" type="number" step="1" @bind="costPerTrip" />
                        <div class="form-text">Internt estimat (chauffør, bil, planlægning mv.).</div>
                    </div>
                </div>

                <div class="row g-3">
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-body">
                                <h6 class="mb-3">Operationelt</h6>

                                <div class="d-flex justify-content-between">
                                    <div>Forventede ture/år (anbefalet)</div>
                                    <div><b>@RecTripsPerYear.ToString("N0")</b></div>
                                </div>

                                <div class="d-flex justify-content-between">
                                    <div>Ture/år (baseline, historisk)</div>
                                    <div><b>@BaseTripsPerYearText</b></div>
                                </div>

                                <hr />

                                <div class="d-flex justify-content-between">
                                    <div><b>Potentiale: færre ture/år</b></div>
                                    <div><b>@TripsSavedPerYearText</b></div>
                                </div>

                                <div class="text-muted small mt-2">
                                    Baseline beregnes ud fra unikke “tømmedage” i perioden (restaffald via Indhold=710100).
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-body">
                                <h6 class="mb-3">ESG (CO₂) & økonomi</h6>

                                <div class="d-flex justify-content-between">
                                    <div>CO₂/år (anbefalet)</div>
                                    <div><b>@RecCo2Year.ToString("N0") kg</b></div>
                                </div>
                                <div class="d-flex justify-content-between">
                                    <div>Omkostning/år (anbefalet)</div>
                                    <div><b>@RecCostYear.ToString("N0") kr</b></div>
                                </div>

                                <hr />

                                <div class="d-flex justify-content-between">
                                    <div>CO₂/år (baseline)</div>
                                    <div><b>@BaseCo2YearText</b></div>
                                </div>
                                <div class="d-flex justify-content-between">
                                    <div>Omkostning/år (baseline)</div>
                                    <div><b>@BaseCostYearText</b></div>
                                </div>

                                <hr />

                                <div class="d-flex justify-content-between">
                                    <div><b>Potentiale CO₂/år</b></div>
                                    <div><b>@Co2SavedYearText</b></div>
                                </div>
                                <div class="d-flex justify-content-between">
                                    <div><b>Potentiale kr/år</b></div>
                                    <div><b>@CostSavedYearText</b></div>
                                </div>

                                <div class="text-muted small mt-2">
                                    Estimatet fokuserer på transport/indsamling (Scope 1/3 afhænger af jeres ESG-ramme).
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="card mt-3">
                    <div class="card-body">
                        <h6 class="mb-2">Sanity-check (restaffald, volumen-antagelse)</h6>

                        <div class="row">
                            <div class="col-md-4">
                                <div class="text-muted small">Antaget densitet</div>
                                <div><b>@densityKgPerL.ToString("0.##") kg/L</b></div>
                            </div>
                            <div class="col-md-4">
                                <div class="text-muted small">Est. volumen pr. dag</div>
                                <div><b>@EstLitersPerDay.ToString("N0") L/dag</b></div>
                            </div>
                            <div class="col-md-4">
                                <div class="text-muted small">Est. fyldning pr. tømning</div>
                                <div><b>@EstFillAtPickup.ToString("P0")</b></div>
                            </div>
                        </div>

                        <div class="text-muted small mt-2">
                            Hurtig plausibilitetscheck: (kg/dag → liter/dag) sammenholdt med containerkapacitet og frekvens.
                        </div>
                    </div>
                </div>

                @if (baseline is not null && baseline.TripDays > 0)
                {
                    <div class="card mt-3">
                        <div class="card-body">
                            <h6 class="mb-2">Baseline nøgletal (historisk)</h6>
                            <div class="row">
                                <div class="col-md-4">
                                    <div class="text-muted small">Tømmedage i perioden</div>
                                    <div><b>@baseline.TripDays</b></div>
                                </div>
                                <div class="col-md-4">
                                    <div class="text-muted small">Total kg (rest) i perioden</div>
                                    <div><b>@baseline.TotalKg.ToString("N0")</b></div>
                                </div>
                                <div class="col-md-4">
                                    <div class="text-muted small">Kg pr. “tømmedag” (proxy)</div>
                                    <div><b>@baseline.AvgKgPerTrip.ToString("N0")</b></div>
                                </div>
                            </div>
                            <div class="text-muted small mt-2">
                                Baseline er et “proxy” baseret på registrerede modtagelseslinjer pr. dato (ikke kontrakt/faktisk stop-tælling).
                            </div>
                        </div>
                    </div>
                }
            </div>
        </div>

        <div class="d-flex gap-2">
            <button class="btn btn-outline-secondary" @onclick="Back">Tilbage</button>
            <button class="btn btn-primary" @onclick="Load">Genindlæs</button>
            <button class="btn btn-outline-primary" @onclick="PrintPdf">Print / PDF</button>
        </div>

    </div>
}
else
{
    <div>Ingen recommendation fundet.</div>
}


@code {
    [Parameter] public string CustomerNo { get; set; } = "";

    DateTime from = new(2024, 1, 1);
    DateTime to = new(2024, 12, 31);

    bool busy;
    string? error;

    RecommendationDto? rec;
    BaselineDto? baseline;

    // Antagelser (UI)
    double kmPerTrip = 20;
    double co2PerKm = 1.2;     // kg CO2 pr km
    double costPerTrip = 500;  // kr pr tur

    // Volumen antagelse
    const double densityKgPerL = 0.13;

    public sealed record RecommendationDto(
        string CustomerNo,
        string CustomerName,
        int ContainerL,
        int ContainerCount,
        int FrequencyDays,
        double ExpectedFill,
        double PredKgPerDaySafe
    );

    public sealed record BaselineDto(
        string CustomerNo,
        string CustomerName,
        DateTime From,
        DateTime To,
        int PeriodDays,
        int TripDays,
        double TotalKg,
        double TripsPerYear,
        double AvgKgPerTrip,
        double AvgKgPerDayCalendar,
        double AvgKgPerDayOnTripDays
    );

    protected override async Task OnParametersSetAsync()
        => await Load();

    async Task Load()
    {
        busy = true;
        error = null;
        rec = null;
        baseline = null;

        try
        {
            var token = await Tokens.GetAsync();
            if (string.IsNullOrWhiteSpace(token))
            {
                error = "Du er ikke logget ind (mangler token).";
                return;
            }

            Http.DefaultRequestHeaders.Authorization = new AuthenticationHeaderValue("Bearer", token);

            var recUrl =
                $"api/ml/recommend-one?from={from:yyyy-MM-dd}&to={to:yyyy-MM-dd}&customerNo={Uri.EscapeDataString(CustomerNo)}";

            var baseUrl =
                $"api/ml/baseline?from={from:yyyy-MM-dd}&to={to:yyyy-MM-dd}&customerNo={Uri.EscapeDataString(CustomerNo)}";

            var recResp = await Http.GetAsync(recUrl);
            if (recResp.StatusCode == System.Net.HttpStatusCode.NotFound)
            {
                error = "Ingen recommendation fundet (404).";
                return;
            }
            if (!recResp.IsSuccessStatusCode)
            {
                error = $"Kunne ikke hente recommendation ({(int)recResp.StatusCode})";
                return;
            }

            rec = await recResp.Content.ReadFromJsonAsync<RecommendationDto>();
            if (rec is null)
            {
                error = "Kunne ikke læse recommendation fra serveren.";
                return;
            }

            // baseline er “nice to have” – hvis den fejler, vis stadig recommendation
            var baseResp = await Http.GetAsync(baseUrl);
            if (baseResp.IsSuccessStatusCode)
            {
                baseline = await baseResp.Content.ReadFromJsonAsync<BaselineDto>();
            }
        }
        catch (Exception ex)
        {
            error = ex.Message;
        }
        finally
        {
            busy = false;
        }
    }

   async Task PrintPdf()
{
    await JS.InvokeVoidAsync("window.print");
}


    void Back() => Nav.NavigateTo("/ml-customers");

    // -------------------------
    // Derived UI values (Efter)
    // -------------------------
    double RecTripsPerYear => rec is null || rec.FrequencyDays <= 0 ? 0 : 365.0 / rec.FrequencyDays;

    double RecCo2Year => RecTripsPerYear * kmPerTrip * co2PerKm;
    double RecCostYear => RecTripsPerYear * costPerTrip;

    // Baseline “før”
    string BaseTripsPerYearText => baseline is null || baseline.TripDays <= 0
        ? "—"
        : baseline.TripsPerYear.ToString("N0");

    double? BaseTripsPerYear => baseline is null || baseline.TripDays <= 0 ? null : baseline.TripsPerYear;

    string BaseCo2YearText => BaseTripsPerYear is null
        ? "—"
        : (BaseTripsPerYear.Value * kmPerTrip * co2PerKm).ToString("N0") + " kg";

    string BaseCostYearText => BaseTripsPerYear is null
        ? "—"
        : (BaseTripsPerYear.Value * costPerTrip).ToString("N0") + " kr";

    // Potentiale
    string TripsSavedPerYearText => BaseTripsPerYear is null
        ? "—"
        : Math.Max(0, BaseTripsPerYear.Value - RecTripsPerYear).ToString("N0");

    string Co2SavedYearText => BaseTripsPerYear is null
        ? "—"
        : Math.Max(0, (BaseTripsPerYear.Value - RecTripsPerYear) * kmPerTrip * co2PerKm).ToString("N0") + " kg";

    string CostSavedYearText => BaseTripsPerYear is null
        ? "—"
        : Math.Max(0, (BaseTripsPerYear.Value - RecTripsPerYear) * costPerTrip).ToString("N0") + " kr";

    // Sanity
    double EstLitersPerDay => rec is null ? 0 : (rec.PredKgPerDaySafe / densityKgPerL);

    double EstFillAtPickup
    {
        get
        {
            if (rec is null) return 0;
            if (rec.FrequencyDays <= 0) return 0;
            var litersPerPickup = EstLitersPerDay * rec.FrequencyDays;
            var totalCapacity = rec.ContainerCount * rec.ContainerL;
            if (totalCapacity <= 0) return 0;
            return litersPerPickup / totalCapacity;
        }
    }

    (bool outOfScope, string msg) IsOutOfScope(RecommendationDto r)
{
    // Justér thresholds efter jeres regler
    const int max1100Count = 12;         // 1100L "for mange"
    const int hardStop1100Count = 15;    // dit eksempel

    var totalL = r.ContainerCount * r.ContainerL;

    if (r.ContainerL == 1100 && r.ContainerCount >= hardStop1100Count)
        return (true, $"Anbefalingen kræver {r.ContainerCount} × 1100 L ({totalL:N0} L). Det tyder på at kunden er for stor til små containere.");

    if (r.ContainerL == 1100 && r.ContainerCount > max1100Count)
        return (true, $"Anbefalingen kræver {r.ContainerCount} × 1100 L ({totalL:N0} L). Overvej stor-container/komprimator løsning.");
    return (false, "");
}

}
