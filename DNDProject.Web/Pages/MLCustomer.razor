@page "/ml-customer/{CustomerNo}"
@using System.Net.Http.Headers
@using System.Net.Http.Json
@using DNDProject.Web.Components
@inject HttpClient Http
@inject DNDProject.Web.Services.ITokenStorage Tokens
@inject NavigationManager Nav
@inject IJSRuntime JS


<h3>ML – Anbefaling (@CustomerNo)</h3>

<button class="btn btn-link p-0 mb-3" @onclick="Back">← Tilbage</button>

@if (!string.IsNullOrWhiteSpace(error))
{
    <div class="alert alert-danger">@error</div>
}
else if (busy)
{
    <div>Henter...</div>
}
else if (rec is not null)
{
    // live-beregninger pr. render (så dropdowns opdaterer med det samme)
    var currentFill = ExpectedFill(rec.PredKgPerDaySafe, densityKgPerL, Current.FrequencyDays, Current.ContainerL, Current.ContainerCount);
    var proposedFill = ExpectedFill(rec.PredKgPerDaySafe, densityKgPerL, Proposed.FrequencyDays, Proposed.ContainerL, Proposed.ContainerCount);

    var currentTrips = TripsPerYear(Current.FrequencyDays);
    var proposedTrips = TripsPerYear(Proposed.FrequencyDays);

    var tripsSaved = currentTrips - proposedTrips;

    var currentCo2 = currentTrips * kmPerTrip * co2PerKm;
    var proposedCo2 = proposedTrips * kmPerTrip * co2PerKm;
    var co2Saved = currentCo2 - proposedCo2;

    var currentCost = currentTrips * costPerTrip;
    var proposedCost = proposedTrips * costPerTrip;
    var costSaved = currentCost - proposedCost;

    var outOfScope = (Proposed.ContainerL == 1100 && Proposed.ContainerCount >= 15);

    <div style="max-width: 1100px;">

        <div class="d-flex gap-2 mb-3">
            <button class="btn btn-outline-secondary" @onclick="Back">← Tilbage</button>
            <button class="btn btn-outline-primary" @onclick="PrintPdf">Print / PDF</button>
            <button class="btn btn-primary" @onclick="Load">Genindlæs</button>
        </div>

        <!-- TOP: NUVÆRENDE vs ANBEFALET -->
        <div class="row g-3 mb-3">
            <!-- NUVÆRENDE -->
            <div class="col-12 col-lg-6">
                <div class="card h-100">
                    <div class="card-body">
                        <h5 class="card-title mb-1">Nuværende setup</h5>
                        <div class="text-muted mb-3">@rec.CustomerName (Kundenr: @rec.CustomerNo)</div>

                        <div class="row g-2">
                            <div class="col-6">
                                <label class="form-label">Container størrelse</label>
                                <select class="form-select" @bind="Current.ContainerL">
                                    @foreach (var s in AllowedSizes)
                                    {
                                        <option value="@s">@s L</option>
                                    }
                                </select>
                            </div>

                            <div class="col-6">
                                <label class="form-label">Antal containere</label>
                                <select class="form-select" @bind="Current.ContainerCount">
                                    @for (int i = 1; i <= 30; i++)
                                    {
                                        <option value="@i">@i</option>
                                    }
                                </select>
                            </div>

                            <div class="col-12">
                                <label class="form-label">Frekvens (dage)</label>
                                <select class="form-select" @bind="Current.FrequencyDays">
                                    @foreach (var d in AllowedFrequencies)
                                    {
                                        <option value="@d">Hver @d dage</option>
                                    }
                                </select>
                            </div>
                        </div>

                        <hr />

                        <dl class="row mb-0">
                            <dt class="col-sm-5">Est. fill ved tømning</dt>
                            <dd class="col-sm-7">@currentFill.ToString("P0")</dd>

                            <dt class="col-sm-5">Ture/år (est.)</dt>
                            <dd class="col-sm-7">@currentTrips.ToString("N0")</dd>

                            <dt class="col-sm-5">Pred kg/dag (safe)</dt>
                            <dd class="col-sm-7">@rec.PredKgPerDaySafe.ToString("N0")</dd>
                        </dl>

                        <div class="text-muted small mt-2">
                            “Nuværende setup” kan justeres hvis kontraktopsætningen afviger fra historik.
                        </div>
                    </div>
                </div>
            </div>

            <!-- ANBEFALET -->
            <div class="col-12 col-lg-6">
                <div class="card h-100 border-primary">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-start">
                            <div>
                                <h5 class="card-title mb-1">Anbefalet setup (ML)</h5>
                                <div class="text-muted">Starter på ML – kan justeres</div>
                            </div>

                            <button class="btn btn-sm btn-outline-primary" @onclick="ResetProposedToMl">
                                Reset til ML
                            </button>
                        </div>

                        <div class="row g-2 mt-2">
                            <div class="col-6">
                                <label class="form-label">Container størrelse</label>
                                <select class="form-select" @bind="Proposed.ContainerL">
                                    @foreach (var s in AllowedSizes)
                                    {
                                        <option value="@s">@s L</option>
                                    }
                                </select>
                            </div>

                            <div class="col-6">
                                <label class="form-label">Antal containere</label>
                                <select class="form-select" @bind="Proposed.ContainerCount">
                                    @for (int i = 1; i <= 30; i++)
                                    {
                                        <option value="@i">@i</option>
                                    }
                                </select>
                            </div>

                            <div class="col-12">
                                <label class="form-label">Frekvens (dage)</label>
                                <select class="form-select" @bind="Proposed.FrequencyDays">
                                    @foreach (var d in AllowedFrequencies)
                                    {
                                        <option value="@d">Hver @d dage</option>
                                    }
                                </select>
                            </div>
                        </div>

                        <hr />

                        <dl class="row mb-0">
                            <dt class="col-sm-5">Est. fill ved tømning</dt>
                            <dd class="col-sm-7">@proposedFill.ToString("P0")</dd>

                            <dt class="col-sm-5">Ture/år (est.)</dt>
                            <dd class="col-sm-7">@proposedTrips.ToString("N0")</dd>

                            <dt class="col-sm-5">ML default</dt>
                            <dd class="col-sm-7">@rec.ContainerCount × @rec.ContainerL L • hver @rec.FrequencyDays dage</dd>
                        </dl>

                        @if (outOfScope)
                        {
                            <div class="alert alert-warning mt-3 mb-0">
                                Setup virker uden for “små beholdere”-scope (fx 15 × 1100L).
                                Overvej en anden model/tilgang (komprimator/skip/storkunde-løsning).
                            </div>
                        }
                    </div>
                </div>
            </div>
        </div>

        <!-- RUBRIK: BESPARELSE -->
        <div class="card mb-3">
            <div class="card-body">
                <h5 class="mb-1">Besparelse (nuværende → valgt setup)</h5>
                <div class="text-muted mb-3">Estimat baseret på antagelserne nedenfor.</div>

                <div class="row g-3 mb-3">
                    <div class="col-md-4">
                        <label class="form-label">Km pr. tur (antagelse)</label>
                        <input class="form-control" type="number" step="1" @bind="kmPerTrip" />
                    </div>
                    <div class="col-md-4">
                        <label class="form-label">CO₂ pr. km (kg/km)</label>
                        <input class="form-control" type="number" step="0.1" @bind="co2PerKm" />
                    </div>
                    <div class="col-md-4">
                        <label class="form-label">Omkostning pr. tur (kr)</label>
                        <input class="form-control" type="number" step="1" @bind="costPerTrip" />
                    </div>
                </div>

                <div class="row g-3">
                    <div class="col-md-4">
                        <div class="border rounded p-3">
                            <div class="text-muted small">Potentiale: færre ture/år</div>
                            <div class="fs-5 fw-semibold">@tripsSaved.ToString("N0")</div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="border rounded p-3">
                            <div class="text-muted small">Potentiale CO₂/år</div>
                            <div class="fs-5 fw-semibold">@co2Saved.ToString("N0") kg</div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="border rounded p-3">
                            <div class="text-muted small">Potentiale kr/år</div>
                            <div class="fs-5 fw-semibold">@costSaved.ToString("N0") kr</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

    </div>
}

else
{
    <div>Ingen recommendation fundet.</div>
}


@code {
    [Parameter] public string CustomerNo { get; set; } = "";

    DateTime from = new(2024, 1, 1);
    DateTime to = new(2024, 12, 31);

    bool busy;
    string? error;

    RecommendationDto? rec;
    BaselineDto? baseline;

    // Antagelser (UI)
    double kmPerTrip = 20;
    double co2PerKm = 1.2;     // kg CO2 pr km
    double costPerTrip = 500;  // kr pr tur

    // Volumen antagelse
    const double densityKgPerL = 0.13;

    public sealed record RecommendationDto(
        string CustomerNo,
        string CustomerName,
        int ContainerL,
        int ContainerCount,
        int FrequencyDays,
        double ExpectedFill,
        double PredKgPerDaySafe
    );

    public sealed record BaselineDto(
        string CustomerNo,
        string CustomerName,
        DateTime From,
        DateTime To,
        int PeriodDays,
        int TripDays,
        double TotalKg,
        double TripsPerYear,
        double AvgKgPerTrip,
        double AvgKgPerDayCalendar,
        double AvgKgPerDayOnTripDays
    );

    protected override async Task OnParametersSetAsync()
        => await Load();

    async Task Load()
    {
        busy = true;
        error = null;
        rec = null;
        baseline = null;

        try
        {
            var token = await Tokens.GetAsync();
            if (string.IsNullOrWhiteSpace(token))
            {
                error = "Du er ikke logget ind (mangler token).";
                return;
            }

            Http.DefaultRequestHeaders.Authorization = new AuthenticationHeaderValue("Bearer", token);

            var recUrl =
                $"api/ml/recommend-one?from={from:yyyy-MM-dd}&to={to:yyyy-MM-dd}&customerNo={Uri.EscapeDataString(CustomerNo)}";

            var baseUrl =
                $"api/ml/baseline?from={from:yyyy-MM-dd}&to={to:yyyy-MM-dd}&customerNo={Uri.EscapeDataString(CustomerNo)}";

            var recResp = await Http.GetAsync(recUrl);
            if (recResp.StatusCode == System.Net.HttpStatusCode.NotFound)
            {
                error = "Ingen recommendation fundet (404).";
                return;
            }
            if (!recResp.IsSuccessStatusCode)
            {
                error = $"Kunne ikke hente recommendation ({(int)recResp.StatusCode})";
                return;
            }

            rec = await recResp.Content.ReadFromJsonAsync<RecommendationDto>();
            if (rec is null)
            {
                error = "Kunne ikke læse recommendation fra serveren.";
                return;
            }
InitSetupsFromRec();
            // baseline er “nice to have” – hvis den fejler, vis stadig recommendation
            var baseResp = await Http.GetAsync(baseUrl);
            if (baseResp.IsSuccessStatusCode)
            {
                baseline = await baseResp.Content.ReadFromJsonAsync<BaselineDto>();
            }
        }
        catch (Exception ex)
        {
            error = ex.Message;
        }
        finally
        {
            busy = false;
        }
    }

   async Task PrintPdf()
{
    await JS.InvokeVoidAsync("window.print");
}


    void Back() => Nav.NavigateTo("/ml-customers");

    // -------------------------
    // Derived UI values (Efter)
    // -------------------------
    double RecTripsPerYear => rec is null || rec.FrequencyDays <= 0 ? 0 : 365.0 / rec.FrequencyDays;

    double RecCo2Year => RecTripsPerYear * kmPerTrip * co2PerKm;
    double RecCostYear => RecTripsPerYear * costPerTrip;

    // Baseline “før”
    string BaseTripsPerYearText => baseline is null || baseline.TripDays <= 0
        ? "—"
        : baseline.TripsPerYear.ToString("N0");

    double? BaseTripsPerYear => baseline is null || baseline.TripDays <= 0 ? null : baseline.TripsPerYear;

    string BaseCo2YearText => BaseTripsPerYear is null
        ? "—"
        : (BaseTripsPerYear.Value * kmPerTrip * co2PerKm).ToString("N0") + " kg";

    string BaseCostYearText => BaseTripsPerYear is null
        ? "—"
        : (BaseTripsPerYear.Value * costPerTrip).ToString("N0") + " kr";

    // Potentiale
    string TripsSavedPerYearText => BaseTripsPerYear is null
        ? "—"
        : Math.Max(0, BaseTripsPerYear.Value - RecTripsPerYear).ToString("N0");

    string Co2SavedYearText => BaseTripsPerYear is null
        ? "—"
        : Math.Max(0, (BaseTripsPerYear.Value - RecTripsPerYear) * kmPerTrip * co2PerKm).ToString("N0") + " kg";

    string CostSavedYearText => BaseTripsPerYear is null
        ? "—"
        : Math.Max(0, (BaseTripsPerYear.Value - RecTripsPerYear) * costPerTrip).ToString("N0") + " kr";

    // Sanity
    double EstLitersPerDay => rec is null ? 0 : (rec.PredKgPerDaySafe / densityKgPerL);

    double EstFillAtPickup
    {
        get
        {
            if (rec is null) return 0;
            if (rec.FrequencyDays <= 0) return 0;
            var litersPerPickup = EstLitersPerDay * rec.FrequencyDays;
            var totalCapacity = rec.ContainerCount * rec.ContainerL;
            if (totalCapacity <= 0) return 0;
            return litersPerPickup / totalCapacity;
        }
    }

    (bool outOfScope, string msg) IsOutOfScope(RecommendationDto r)
{
    // Justér thresholds efter jeres regler
    const int max1100Count = 12;         // 1100L "for mange"
    const int hardStop1100Count = 15;    // dit eksempel

    var totalL = r.ContainerCount * r.ContainerL;

    if (r.ContainerL == 1100 && r.ContainerCount >= hardStop1100Count)
        return (true, $"Anbefalingen kræver {r.ContainerCount} × 1100 L ({totalL:N0} L). Det tyder på at kunden er for stor til små containere.");

    if (r.ContainerL == 1100 && r.ContainerCount > max1100Count)
        return (true, $"Anbefalingen kræver {r.ContainerCount} × 1100 L ({totalL:N0} L). Overvej stor-container/komprimator løsning.");
    return (false, "");
}
class Setup
{
    public int ContainerL { get; set; } = 1100;
    public int ContainerCount { get; set; } = 1;
    public int FrequencyDays { get; set; } = 14;
}

Setup Current { get; set; } = new();
Setup Proposed { get; set; } = new();

static readonly int[] AllowedSizes = { 120, 240, 660, 1100 };
static readonly int[] AllowedFrequencies = { 3, 7, 10, 14, 21, 28, 35, 42, 56 };


// kald den her lige efter du har sat rec (når Load() henter data)
void InitSetupsFromRec()
{
    // Proposed starter altid på ML
    Proposed.ContainerL = rec!.ContainerL;
    Proposed.ContainerCount = rec!.ContainerCount;
    Proposed.FrequencyDays = rec!.FrequencyDays;

    // Current: start som “udgangspunkt”
    // (Hvis du senere får kontraktdata, kan Current sættes fra API i stedet)
    Current.ContainerL = rec!.ContainerL;
    Current.ContainerCount = rec!.ContainerCount;
    Current.FrequencyDays = rec!.FrequencyDays;
}

void ResetProposedToMl()
{
    if (rec is null) return;
    Proposed.ContainerL = rec.ContainerL;
    Proposed.ContainerCount = rec.ContainerCount;
    Proposed.FrequencyDays = rec.FrequencyDays;
}

static double TripsPerYear(int frequencyDays)
{
    frequencyDays = Math.Max(1, frequencyDays);
    return 365.0 / frequencyDays;
}

static double ExpectedFill(double kgPerDay, double densityKgPerLiter, int frequencyDays, int containerSizeLiters, int containerCount)
{
    kgPerDay = Math.Max(0, kgPerDay);
    densityKgPerLiter = densityKgPerLiter > 0 ? densityKgPerLiter : 0.13;
    frequencyDays = Math.Max(1, frequencyDays);
    containerSizeLiters = Math.Max(1, containerSizeLiters);
    containerCount = Math.Max(1, containerCount);

    double litersPerDay = kgPerDay / densityKgPerLiter;
    double litersPerEmptyTotal = litersPerDay * frequencyDays;
    double totalCapacityLiters = containerCount * (double)containerSizeLiters;

    return totalCapacityLiters <= 0 ? 0 : (litersPerEmptyTotal / totalCapacityLiters);
}
}
