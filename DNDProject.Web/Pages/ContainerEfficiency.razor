@page "/container-efficiency"

@using System.Net.Http.Json
@using DNDProject.Web.Models
@inject HttpClient Http

<h3>Kunde – tømningsanalyse (660 L container)</h3>

@if (!string.IsNullOrEmpty(_error))
{
    <div class="alert alert-danger">@_error</div>
}

<div class="row">
    <!-- Venstre: kunde-oversigt -->
    <div class="col-md-4 border-end">

        <h5>Alle kunder</h5>
        <p class="text-muted mb-1">
            Viser andel af tømninger, hvor fyldningen er under grænsen.
        </p>

        <div class="row mb-2">
            <div class="col-7">
                <input class="form-control form-control-sm"
                       placeholder="Søg på kundenavn eller nummer..."
                       @bind="_searchText" />
            </div>
            <div class="col-3">
                <select class="form-select form-select-sm"
                        @onchange="OnMonthsChanged">
                    <option value="3" selected="@(_months == 3)">3 mdr</option>
                    <option value="6" selected="@(_months == 6)">6 mdr</option>
                    <option value="12" selected="@(_months == 12)">12 mdr</option>
                    <option value="24" selected="@(_months == 24)">24 mdr</option>
                </select>
            </div>
            <div class="col-2">
                <select class="form-select form-select-sm"
                        @onchange="OnThresholdChanged">
                    <option value="70" selected="@(_thresholdPct == 70)">70%</option>
                    <option value="75" selected="@(_thresholdPct == 75)">75%</option>
                    <option value="80" selected="@(_thresholdPct == 80)">80%</option>
                    <option value="85" selected="@(_thresholdPct == 85)">85%</option>
                </select>
            </div>
        </div>

        <table class="table table-sm table-hover">
            <thead class="table-light">
                <tr>
                    <th style="width: 70px;">Kunde</th>
                    <th>Navn</th>
                    <th class="text-end" style="width: 90px;">Ineffektiv / total</th>
                    <th class="text-end" style="width: 70px;">% ineff.</th>
                </tr>
            </thead>
            <tbody>
                @if (_customers is null || !_customers.Any())
                {
                    <tr>
                        <td colspan="4" class="text-muted">Ingen kunder fundet.</td>
                    </tr>
                }
                else
                {
                    @foreach (var c in FilteredCustomers)
                    {
                        var isSelected = _selectedCustomer?.LevNr == c.LevNr;
                        var rowClass = isSelected ? "table-primary" : string.Empty;

                        <tr class="@rowClass"
                            style="cursor:pointer;"
                            @onclick="(() => OnCustomerClicked(c))">
                            <td>@c.LevNr</td>
                            <td>@c.CustomerName</td>
                            <td class="text-end">
                                @c.InefficientEmpties / @c.TotalEmpties
                            </td>
                            <td class="text-end">
                                @c.InefficientPct.ToString("N1")%
                            </td>
                        </tr>
                    }

                    if (!FilteredCustomers.Any())
                    {
                        <tr>
                            <td colspan="4" class="text-muted">Ingen kunder matcher søgningen.</td>
                        </tr>
                    }
                }
            </tbody>
        </table>
    </div>

    <!-- Højre: detaljer for valgt kunde -->
    <div class="col-md-8">
        @if (_selectedCustomer is null)
        {
            <p class="text-muted mt-3">
                Vælg en kunde i listen til venstre.
            </p>
        }
        else if (_details is null)
        {
            @if (_isLoading)
            {
                <p class="mt-3">Henter detaljer for kunde @_selectedCustomer.LevNr...</p>
            }
            else
            {
                <p class="text-muted mt-3">Ingen detaljer at vise.</p>
            }
        }
        else
        {
            var s = _details;

            <div class="d-flex justify-content-between align-items-start mb-2 mt-2">
                <div>
                    <h5>
                        Detaljer for: @s.LevNr – @s.CustomerName
                    </h5>
                    <div>
                        Containerkapacitet:
                        <strong>@s.CapacityKg.ToString("N1") kg</strong>
                        <span class="text-muted">(660 L × 0,13 kg/L)</span>
                    </div>
                    <div>
                        Grænse for ineffektiv tømning:
                        <strong>@s.ThresholdPct.ToString("N0") %</strong>
                    </div>
                    <div>
                        Tømninger i perioden:
                        <strong>@s.TotalEmpties</strong>,
                        heraf ineffektive:
                        <strong>@s.InefficientEmpties (@s.InefficientPct.ToString("N1")%)</strong>
                    </div>
                    <div>
                        Gennemsnitlig fyldningsgrad:
                        <strong>@s.AvgFillPct.ToString("N1")%</strong>
                    </div>
                </div>

                <div class="text-end">
                    <small class="d-block">
                        <span class="badge bg-success me-1">&nbsp;</span>Over grænse
                    </small>
                    <small class="d-block">
                        <span class="badge bg-danger me-1">&nbsp;</span>Under grænse
                    </small>
                </div>
            </div>

            <hr />

            <h6>Seneste tømninger</h6>
            <p class="text-muted">
                Viser op til de seneste 50 tømninger. Grøn = fyldning over grænsen, rød = tømt for tidligt.
            </p>

            @if (s.Empties is null || !s.Empties.Any())
            {
                <p class="text-muted">Ingen tømninger i den valgte periode.</p>
            }
            else
            {
                float maxFill = s.Empties.Max(e => e.FillPct);
                if (maxFill <= 0) { maxFill = 100; }

                <div class="mb-2">
                    @foreach (var e in s.Empties)
                    {
                        var pctLabel = e.FillPct.ToString("N1") + "%";
                        var widthPct = Math.Clamp(e.FillPct, 0, 150); // bar-længde
                        var isBad = e.FillPct < s.ThresholdPct;
                        var barClass = isBad ? "bg-danger" : "bg-success";

                        <div class="mb-1">
                            <div class="d-flex justify-content-between small">
                                <span>@e.KoeresDato.ToString("yyyy-MM-dd")</span>
                                <span>@e.WeightKg.ToString("N1") kg (@pctLabel)</span>
                            </div>
                            <div class="progress" style="height: 10px;">
                                <div class="progress-bar @barClass"
                                     role="progressbar"
                                     style="width:@widthPct%;"
                                     aria-valuenow="@e.FillPct"
                                     aria-valuemin="0"
                                     aria-valuemax="150">
                                </div>
                            </div>
                        </div>
                    }
                </div>
            }
        }
    </div>
</div>

@code {
    private List<ContainerEfficiencyCustomerSummaryDto>? _customers;
    private ContainerEfficiencyCustomerSummaryDto? _selectedCustomer;
    private ContainerEfficiencyCustomerDetailDto? _details;

    private bool _isLoading = false;
    private string? _error;

    private int _months = 12;
    private int _thresholdPct = 80;
    private string _searchText = string.Empty;

    private IEnumerable<ContainerEfficiencyCustomerSummaryDto> FilteredCustomers =>
        string.IsNullOrWhiteSpace(_searchText)
            ? _customers ?? Enumerable.Empty<ContainerEfficiencyCustomerSummaryDto>()
            : (_customers ?? Enumerable.Empty<ContainerEfficiencyCustomerSummaryDto>())
                .Where(c =>
                    (c.CustomerName ?? string.Empty)
                        .Contains(_searchText, StringComparison.OrdinalIgnoreCase)
                    || c.LevNr.ToString().Contains(_searchText, StringComparison.OrdinalIgnoreCase));

    protected override async Task OnInitializedAsync()
    {
        await LoadSummaries();
    }

    private async Task LoadSummaries()
    {
        _error = null;
        _isLoading = true;

        try
        {
            var uri = $"api/stena/efficiency/660/summary?months={_months}&thresholdPct={_thresholdPct}";
            _customers = await Http.GetFromJsonAsync<List<ContainerEfficiencyCustomerSummaryDto>>(uri);

            if (_customers is not null && _customers.Count > 0)
            {
                _selectedCustomer = _customers[0];
                await LoadDetails(_selectedCustomer.LevNr);
            }
        }
        catch (Exception ex)
        {
            _error = $"Kunne ikke hente kundeliste: {ex.Message}";
        }
        finally
        {
            _isLoading = false;
        }
    }

    private async Task LoadDetails(int levNr)
    {
        _error = null;
        _isLoading = true;

        try
        {
            var uri = $"api/stena/efficiency/660/customer/{levNr}?months={_months}&thresholdPct={_thresholdPct}";
            _details = await Http.GetFromJsonAsync<ContainerEfficiencyCustomerDetailDto>(uri);
        }
        catch (Exception ex)
        {
            _error = $"Kunne ikke hente detaljer for kunde {levNr}: {ex.Message}";
        }
        finally
        {
            _isLoading = false;
        }
    }

    private async Task OnCustomerClicked(ContainerEfficiencyCustomerSummaryDto customer)
    {
        if (_selectedCustomer?.LevNr == customer.LevNr)
            return;

        _selectedCustomer = customer;
        await LoadDetails(customer.LevNr);
    }

    private async Task OnMonthsChanged(ChangeEventArgs e)
    {
        if (!int.TryParse(e.Value?.ToString(), out var m))
            return;

        _months = m;
        await LoadSummaries();
    }

    private async Task OnThresholdChanged(ChangeEventArgs e)
    {
        if (!int.TryParse(e.Value?.ToString(), out var t))
            return;

        _thresholdPct = t;
        await LoadSummaries();
    }
}
