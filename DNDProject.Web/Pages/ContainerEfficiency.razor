@page "/container-efficiency"

@using System.Text.Json
@using System.Globalization
@using DNDProject.Web.Models
@using DNDProject.Web.Components

@inject HttpClient Http

<h3 class="mb-3">
    Kunde – tømningsanalyse (@(_liters == 0 ? "Alle størrelser" : $"{_liters} L container"))
</h3>

@if (!string.IsNullOrWhiteSpace(_error))
{
    <div class="alert alert-danger">@_error</div>
}

<div class="row g-3">

    <!-- VENSTRE: Kunder -->
    <div class="col-lg-4">
        <div class="card shadow-sm">
            <div class="card-body">

                <h5 class="card-title mb-1">Alle kunder</h5>
                <div class="text-muted small">Formål: find kunder hvor fyldning er for lav eller ustabil.</div>

                <div class="row g-2 mt-3 align-items-end">
                    <div class="col-6">
                        <input class="form-control form-control-sm"
                               placeholder="Søg navn eller kundenr..."
                               @bind="_searchText" />
                    </div>

                    <div class="col-2">
                        <select class="form-select form-select-sm" @onchange="OnMonthsChanged">
                            <option value="3" selected="@(_months == 3)">3 mdr</option>
                            <option value="6" selected="@(_months == 6)">6 mdr</option>
                            <option value="12" selected="@(_months == 12)">12 mdr</option>
                            <option value="24" selected="@(_months == 24)">24 mdr</option>
                        </select>
                    </div>

                    <div class="col-2">
                        <select class="form-select form-select-sm" @onchange="OnThresholdChanged">
                            <option value="70" selected="@(_thresholdPct == 70)">70%</option>
                            <option value="75" selected="@(_thresholdPct == 75)">75%</option>
                            <option value="80" selected="@(_thresholdPct == 80)">80%</option>
                            <option value="85" selected="@(_thresholdPct == 85)">85%</option>
                        </select>
                    </div>

                    <div class="col-2">
                        <select class="form-select form-select-sm" @onchange="OnLitersChanged">
                            <option value="0" selected="@(_liters == 0)">Alle</option>
                            <option value="120" selected="@(_liters == 120)">120L</option>
                            <option value="240" selected="@(_liters == 240)">240L</option>
                            <option value="660" selected="@(_liters == 660)">660L</option>
                            <option value="1100" selected="@(_liters == 1100)">1100L</option>
                        </select>
                    </div>
                </div>

<div class="mt-2 d-flex gap-2 flex-wrap">
    <div class="btn-group" role="group" aria-label="Filter">
        <button class="@ZoneBtnClass("Kritisk")" @onclick='() => SetZone("Kritisk")'>Kritisk</button>
        <button class="@ZoneBtnClass("Gråzone")" @onclick='() => SetZone("Gråzone")'>Gråzone</button>
        <button class="@ZoneBtnClass("OK")"      @onclick='() => SetZone("OK")'>OK</button>
        <button class="@ZoneBtnClass("Alle")"    @onclick='() => SetZone("Alle")'>Alle</button>
    </div>
</div>



                <div class="mt-3" style="max-height:70vh; overflow:auto;">
                    <table class="table table-sm table-hover align-middle mb-0">
                        <thead class="table-light sticky-top">
                            <tr>
                                <th style="width:80px;">Kunde</th>
                                <th>Navn</th>
                                <th class="text-end" style="width:60px;">L</th>
                                <th class="text-end" style="width:110px;">Under</th>
                                <th class="text-end" style="width:70px;">%</th>
                            </tr>
                        </thead>
                        <tbody>
                            @if (_customers == null || !_customers.Any())
                            {
                                <tr>
                                    <td colspan="5" class="text-muted">
                                        @_isLoading ? "Henter kunder..." : "Ingen kunder fundet."
                                    </td>
                                </tr>
                            }
                            else
                            {
                                @foreach (var c in FilteredCustomersV2)
                                {
                                    var selected =
                                        _selectedCustomer?.CustomerKey == c.CustomerKey &&
                                        _selectedCustomer?.Liters == c.Liters;

                                    <tr class="@(selected ? "table-primary" : "")"
                                        style="cursor:pointer"
                                        @onclick="() => SelectCustomer(c)">
                                        <td class="fw-semibold">@c.CustomerKey</td>
                                        <td>
                                            <div class="d-flex align-items-center justify-content-between">
                                                <span>@c.CustomerName</span>
                                                <span class="badge @ZoneBadgeClass(c.AvgFillPct, _thresholdPct)">
                                                    @ZoneLabel(c.AvgFillPct, _thresholdPct)
                                                </span>
                                            </div>
                                        </td>
                                        <td class="text-end">@c.Liters</td>
                                        <td class="text-end">@c.InefficientEmpties / @c.TotalEmpties</td>
                                        <td class="text-end">@c.InefficientPct.ToString("N1")%</td>
                                    </tr>
                                }
                            }
                        </tbody>
                    </table>

                    @if (string.IsNullOrWhiteSpace(_searchText))
                    {
                        <div class="text-muted small mt-2">
                            Viser top 100 efter “diagnose-sortering”. Brug søgning for at finde andre.
                        </div>
                    }
                </div>

            </div>
        </div>
    </div>

    <!-- HØJRE: Detaljer -->
    <div class="col-lg-8">
        <div class="card shadow-sm">
            <div class="card-body">

                @if (_selectedCustomer == null)
                {
                    <div class="text-muted">Vælg en kunde i listen.</div>
                }
                else if (_isLoadingDetails)
                {
                    <div>Henter detaljer...</div>
                }
                else if (_details == null)
                {
                    <div class="text-muted">Ingen detaljer at vise.</div>
                }
                else
                {
                    var d = _details;
                    var latest = LatestEmpty;
                    var avgFillUi = AvgFillForUi; 
                    var isOk = avgFillUi >= d.ThresholdPct;

                    <div class="d-flex justify-content-between align-items-start">
                        <div>
                            <h5 class="mb-1">@d.CustomerName</h5>
                            <div class="text-muted small">Kundenr: <b>@d.CustomerKey</b></div>
                        </div>

                        <span class="badge @(isOk ? "bg-success" : "bg-danger")">
                            @(isOk ? "OK" : "For lav fyldning")
                        </span>
                    </div>

                    <div class="d-flex justify-content-end mt-2">
                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" role="switch"
                                   id="excludeOutliers"
                                   @bind="_excludeOutliersFromKpis" />
                            <label class="form-check-label small text-muted" for="excludeOutliers">
                                Ignorer outliers i KPI’er
                            </label>
                        </div>
                    </div>

                    <!-- TOP KPI -->
                    <div class="row g-2 mt-2">
                        <div class="col-md-3">
                            <div class="border rounded p-2">
                                <div class="text-muted small">Kapacitet</div>
                                <div class="fw-semibold">@d.CapacityKg.ToString("N1") kg</div>
                                <div class="text-muted small">@($"{d.Liters}L × 0,13")</div>
                            </div>
                        </div>

                        <div class="col-md-3">
                            <div class="border rounded p-2">
                                <div class="text-muted small">Grænse</div>
                                <div class="fw-semibold">@d.ThresholdPct%</div>
                                <div class="text-muted small">Under = ineffektiv</div>
                            </div>
                        </div>

                        <div class="col-md-3">
                            <div class="border rounded p-2">
                                <div class="text-muted small">Ineffektiv</div>
                                <div class="fw-semibold">@d.InefficientPct.ToString("N1")%</div>
                                <div class="text-muted small">@d.InefficientEmpties / @d.TotalEmpties</div>
                            </div>
                        </div>

                        <div class="col-md-3">
                            <div class="border rounded p-2">
                                <div class="text-muted small">Gns. fyldning</div>
                                <div class="fw-semibold">@avgFillUi.ToString("N1")%</div>

                                @if (latest != null)
                                {
                                    <div class="text-muted small">
                                        Seneste: @latest.Date.ToString("yyyy-MM-dd") (@FillLabel(latest.FillPct))
                                    </div>
                                }

                                @if (OutlierCount > 0)
                                {
                                    <div class="text-muted small">
                                        Datakvalitet: <b>@OutlierCount</b> outlier(s) (&gt; @MaxDisplayFillPct%)
                                    </div>
                                }
                            </div>
                        </div>
                    </div>

                    <!-- VISUELT OVERBLIK -->
                    <div class="row g-3 mt-3">
                        <div class="col-md-4">
                            <div class="border rounded p-2">
                                <div class="text-muted small mb-2">Under/over grænse</div>
                                <DonutChart Value="@d.InefficientPct" Label="Ineffektiv" />
                                <div class="text-muted small mt-2">
                                    Tip: Brug månedsoversigten til at se om problemet er stabilt.
                                </div>
                            </div>
                        </div>

                        <div class="col-md-8">
                            <div class="border rounded p-2">
                                <div class="text-muted small mb-2">Fyldningsfordeling</div>
                                <FillHistogram Empties="@d.Empties" ThresholdPct="@d.ThresholdPct" />
                                <div class="text-muted small mt-2">
                                    Grøn = over grænse. Gul = gråzone. Rød = kritisk lav.
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="border rounded p-2 mt-3">
                        <div class="d-flex justify-content-between align-items-center">
                            <div class="text-muted small">Månedsoversigt (stabilitet)</div>
                            <div class="text-muted small">(under grænse = &lt; @d.ThresholdPct%)</div>
                        </div>

                        <div class="table-responsive mt-2">
                            <table class="table table-sm align-middle mb-0">
                                <thead class="table-light">
                                    <tr>
                                        <th style="width:90px;">Måned</th>
                                        <th class="text-end" style="width:90px;">Tømninger</th>
                                        <th class="text-end" style="width:140px;">Under grænse</th>
                                        <th class="text-end" style="width:100px;">Gns. fyld</th>
                                        <th style="width:120px;">Signal</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    @foreach (var m in MonthlyRows)
                                    {
                                        <tr>
                                            <td class="fw-semibold">@m.Month</td>
                                            <td class="text-end">@m.Count</td>
                                            <td class="text-end">@m.UnderCount (@m.UnderPct.ToString("N0")%)</td>
                                            <td class="text-end">@m.AvgFill.ToString("N1")%</td>
                                            <td>
                                                <span class="badge @m.BadgeClass">@m.BadgeLabel</span>
                                            </td>
                                        </tr>
                                    }
                                </tbody>
                            </table>
                        </div>

                        <div class="text-muted small mt-2">
                            Signal: <b>Rød</b> = stabilt lav fyldning • <b>Gul</b> = svinger/gråzone • <b>Grøn</b> = OK
                        </div>
                    </div>

                    <div class="d-flex justify-content-between align-items-center mt-3">
                        <h6 class="mb-0">Seneste tømninger</h6>
                        <button class="btn btn-sm btn-outline-secondary" @onclick="ToggleShowAllEmpties">
                            @(_showAllEmpties ? "Vis færre" : "Vis alle")
                        </button>
                    </div>

                    <div class="text-muted small mb-2">
                        Tip: listen her er “rå data” – brug månedsoversigten til mønstre.
                    </div>

                    <div style="max-height:40vh; overflow:auto;">
                        @foreach (var e in VisibleEmpties)
                        {
                            var raw = (double)e.FillPct;
                            var capped = CapFill(raw);
                            var zoneClass = FillClass(raw, d.ThresholdPct);
                            var outlier = IsOutlierFill(raw);

                            <div class="mb-2">
                                <div class="d-flex justify-content-between small">
                                    <span class="text-muted">@e.Date.ToString("yyyy-MM-dd")</span>
                                    <span class="fw-semibold">
                                        @e.WeightKg.ToString("N1") kg
                                        <span class="text-muted">(@FillLabel(raw))</span>
                                    </span>
                                </div>

                                @if (outlier)
                                {
                                    <div class="text-muted small mb-1">@FillSubLabel(raw)</div>
                                }

                                <div class="progress" style="height:10px;">
                                    <div class="progress-bar @zoneClass"
                                         style="width:@capped%"></div>
                                </div>
                            </div>
                        }
                    </div>
                }

            </div>
        </div>
    </div>
</div>

@code {
    private List<ContainerEfficiencyCustomerSummaryDto>? _customers;
    private ContainerEfficiencyCustomerSummaryDto? _selectedCustomer;
    private ContainerEfficiencyCustomerDetailDto? _details;

    private string? _error;
    private int _months = 12;
    private int _thresholdPct = 80;
    private int _liters = 0;
    private string _searchText = "";

    private bool _isLoading;
    private bool _isLoadingDetails;

    // V2 UI state
    private bool _showAllEmpties = false;
    private bool _showOkCustomers = false;

    // KPI outlier toggle (default ON)
    private bool _excludeOutliersFromKpis = true;

    // ---------------------------
    // UI-sanity: fyld% kan være >100% pga. sammentælling/bulk.
    // Vi viser capped i UI, men markerer outliers.
    // ---------------------------
    private const double MaxDisplayFillPct = 150.0; // UI cap (alt over = outlier/warning)

    private static double CapFill(double raw) => Math.Clamp(raw, 0.0, MaxDisplayFillPct);
    private static bool IsOutlierFill(double raw) => raw > MaxDisplayFillPct;

    private static string FillLabel(double raw)
    {
        var capped = CapFill(raw);
        return IsOutlierFill(raw) ? $"{capped:N1}% ⚠" : $"{capped:N1}%";
    }

    private static string FillSubLabel(double raw) =>
        IsOutlierFill(raw) ? $"Rå: {raw:N1}% (sandsynlig sammentælling/bulk)" : "";

    protected override async Task OnInitializedAsync()
        => await LoadSummaries();

    // ---------------------------
    // Details helpers
    // ---------------------------
    private ContainerEmptyingDto? LatestEmpty =>
        _details?.Empties?.OrderByDescending(x => x.Date).FirstOrDefault();

    private int OutlierCount =>
        _details?.Empties?.Count(e => IsOutlierFill(e.FillPct)) ?? 0;

    // Empties til KPI/månedsoversigt (sanitiseret)
    private IEnumerable<ContainerEmptyingDto> EmptiesForStats
    {
        get
        {
            var empties = _details?.Empties ?? new List<ContainerEmptyingDto>();
            if (!_excludeOutliersFromKpis) return empties;

            return empties.Where(e => !IsOutlierFill(e.FillPct));
        }
    }

    private double AvgFillForUi
    {
        get
        {
            var e = EmptiesForStats.ToList();
            if (e.Count == 0) return 0;

            return e.Average(x => CapFill(x.FillPct));
        }
    }

    private IEnumerable<ContainerEmptyingDto> VisibleEmpties
    {
        get
        {
            var empties = _details?.Empties ?? new List<ContainerEmptyingDto>();
            var sorted = empties.OrderByDescending(x => x.Date);
            return _showAllEmpties ? sorted : sorted.Take(10);
        }
    }

    // ---------------------------
    // V2: KUNDER LISTE (smart sort)
    // ---------------------------
   private IEnumerable<ContainerEfficiencyCustomerSummaryDto> FilteredCustomersV2
{
    get
    {
        var src = _customers ?? Enumerable.Empty<ContainerEfficiencyCustomerSummaryDto>();

        // 1) Søgning (hvis der søges, filtrér først)
        if (!string.IsNullOrWhiteSpace(_searchText))
        {
            src = src.Where(c =>
                (c.CustomerName ?? "").Contains(_searchText, StringComparison.OrdinalIgnoreCase)
                || c.CustomerKey.ToString().Contains(_searchText));
        }

        // 2) Zone-filter (Kritisk/Gråzone/OK/Alle)
        src = _zone switch
        {
            "Kritisk" => src.Where(c => c.AvgFillPct < 60),
            "Gråzone" => src.Where(c => c.AvgFillPct >= 60 && c.AvgFillPct < _thresholdPct),
            "OK"      => src.Where(c => c.AvgFillPct >= _thresholdPct),
            _         => src // Alle
        };

        // 3) Sortér så det giver mening inden for det valgte filter
        // (lavest fyldning først, og derefter høj ineffektivitet)
        src = src
            .OrderBy(c => c.AvgFillPct)
            .ThenByDescending(c => c.InefficientPct);

        // Hvis du vil begrænse uden søgning:
        if (string.IsNullOrWhiteSpace(_searchText))
            src = src.Take(100);

        return src;
    }
}

    private void ToggleShowAllEmpties() => _showAllEmpties = !_showAllEmpties;

    private void ToggleShowOk() => _showOkCustomers = !_showOkCustomers;


    // ---------------------------
    // Månedsoversigt rows (sanitiseret)
    // ---------------------------
    private IEnumerable<MonthRow> MonthlyRows
    {
        get
        {
            if (_details?.Empties == null || _details.Empties.Count == 0)
                return Enumerable.Empty<MonthRow>();

            var thr = _details.ThresholdPct;

            return EmptiesForStats
                .GroupBy(e => e.Date.ToString("yyyy-MM", CultureInfo.InvariantCulture))
                .OrderByDescending(g => g.Key)
                .Select(g =>
                {
                    var count = g.Count();
                    var underCount = g.Count(x => x.FillPct < thr);
                    var underPct = count == 0 ? 0 : (underCount * 100.0 / count);

            
                    var avgFill = g.Average(x => CapFill(x.FillPct));

                    string badgeClass;
                    string badgeLabel;

                    if (underPct >= 80 || avgFill < 60)
                    {
                        badgeClass = "bg-danger";
                        badgeLabel = "Kritisk";
                    }
                    else if (underPct >= 40 || avgFill < thr)
                    {
                        badgeClass = "bg-warning text-dark";
                        badgeLabel = "Gråzone";
                    }
                    else
                    {
                        badgeClass = "bg-success";
                        badgeLabel = "OK";
                    }

                    return new MonthRow(g.Key, count, underCount, underPct, avgFill, badgeClass, badgeLabel);
                })
                .ToList();
        }
    }

    private sealed record MonthRow(
        string Month,
        int Count,
        int UnderCount,
        double UnderPct,
        double AvgFill,
        string BadgeClass,
        string BadgeLabel
    );


    // progress farver i rå-liste (inkl. outliers)
    private static string FillClass(double rawFillPct, int thresholdPct)
    {
        if (IsOutlierFill(rawFillPct)) return "bg-warning";
        if (rawFillPct < 60) return "bg-danger";
        if (rawFillPct < thresholdPct) return "bg-warning";
        return "bg-success";
    }

    // ---------------------------
    // Data loading
    // ---------------------------
    private async Task LoadSummaries()
    {
        _isLoading = true;
        _error = null;

        try
        {
            var url = _liters == 0
                ? $"api/stena/efficiency/summary/all?months={_months}&thresholdPct={_thresholdPct}"
                : $"api/stena/efficiency/summary?months={_months}&thresholdPct={_thresholdPct}&liters={_liters}";

            var response = await Http.GetAsync(url);
            var body = await response.Content.ReadAsStringAsync();

            _customers = JsonSerializer.Deserialize<List<ContainerEfficiencyCustomerSummaryDto>>(body,
                new JsonSerializerOptions { PropertyNameCaseInsensitive = true });

            _selectedCustomer = _customers?.FirstOrDefault();
            _details = null;

            if (_selectedCustomer != null)
                await LoadDetails(_selectedCustomer.CustomerKey, _selectedCustomer.Liters);
        }
        catch (Exception ex)
        {
            _error = ex.Message;
        }
        finally
        {
            _isLoading = false;
        }
    }

    private async Task LoadDetails(int customerKey, int liters)
    {
        _isLoadingDetails = true;

        try
        {
            var url = $"api/stena/efficiency/customer/{customerKey}?months={_months}&thresholdPct={_thresholdPct}&liters={liters}";
            var response = await Http.GetAsync(url);
            var body = await response.Content.ReadAsStringAsync();

            _details = JsonSerializer.Deserialize<ContainerEfficiencyCustomerDetailDto>(body,
                new JsonSerializerOptions { PropertyNameCaseInsensitive = true });

            _showAllEmpties = false;
        }
        catch (Exception ex)
        {
            _error = ex.Message;
        }
        finally
        {
            _isLoadingDetails = false;
        }
    }

    private async Task SelectCustomer(ContainerEfficiencyCustomerSummaryDto c)
    {
        if (_selectedCustomer?.CustomerKey == c.CustomerKey &&
            _selectedCustomer?.Liters == c.Liters)
            return;

        _selectedCustomer = c;
        await LoadDetails(c.CustomerKey, c.Liters);
    }

    private async Task OnMonthsChanged(ChangeEventArgs e)
    {
        _months = int.Parse(e.Value!.ToString()!);
        await LoadSummaries();
    }

    private async Task OnThresholdChanged(ChangeEventArgs e)
    {
        _thresholdPct = int.Parse(e.Value!.ToString()!);
        await LoadSummaries();
    }

    private async Task OnLitersChanged(ChangeEventArgs e)
    {
        _liters = int.Parse(e.Value!.ToString()!);
        await LoadSummaries();
    }

private string _zone = "Alle";

private void SetZone(string z) => _zone = z;

private string ZoneBtnClass(string z)
    => "btn btn-sm " + (_zone == z ? "btn-primary" : "btn-outline-secondary");

private static string ZoneLabel(float avgFillPct, int thresholdPct) =>
    avgFillPct < 60 ? "Kritisk" :
    avgFillPct < thresholdPct ? "Gråzone" :
    "OK";

private static string ZoneBadgeClass(float avgFillPct, int thresholdPct) =>
    avgFillPct < 60 ? "bg-danger" :
    avgFillPct < thresholdPct ? "bg-warning text-dark" :
    "bg-success";


}
