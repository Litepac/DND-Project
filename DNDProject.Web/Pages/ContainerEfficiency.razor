@page "/container-efficiency"

@using System.Text.Json
@using System.Globalization
@using DNDProject.Web.Models
@using DNDProject.Web.Components

@inject HttpClient Http

<h3 class="mb-3">
    Kunde – tømningsanalyse (@(_liters == 0 ? "Alle størrelser" : $"{_liters} L container"))
</h3>

@if (!string.IsNullOrWhiteSpace(_error))
{
    <div class="alert alert-danger">@_error</div>
}

<div class="row g-3">

    <!-- VENSTRE: Kunder -->
    <div class="col-lg-4">
        <div class="card shadow-sm">
            <div class="card-body">

                <h5 class="card-title mb-1">Alle kunder</h5>
                <div class="text-muted small">Formål: find kunder hvor fyldning er for lav eller ustabil.</div>

                <div class="row g-2 mt-3 align-items-end">
                    <div class="col-6">
                        <input class="form-control form-control-sm"
                               placeholder="Søg navn eller kundenr..."
                               @bind="_searchText" />
                    </div>

                    <div class="col-2">
                        <select class="form-select form-select-sm" @onchange="OnMonthsChanged">
                            <option value="3" selected="@(_months == 3)">3 mdr</option>
                            <option value="6" selected="@(_months == 6)">6 mdr</option>
                            <option value="12" selected="@(_months == 12)">12 mdr</option>
                            <option value="24" selected="@(_months == 24)">24 mdr</option>
                        </select>
                    </div>

                    <div class="col-2">
                        <select class="form-select form-select-sm" @onchange="OnThresholdChanged">
                            <option value="70" selected="@(_thresholdPct == 70)">70%</option>
                            <option value="75" selected="@(_thresholdPct == 75)">75%</option>
                            <option value="80" selected="@(_thresholdPct == 80)">80%</option>
                            <option value="85" selected="@(_thresholdPct == 85)">85%</option>
                        </select>
                    </div>

                    <div class="col-2">
                        <select class="form-select form-select-sm" @onchange="OnLitersChanged">
                            <option value="0" selected="@(_liters == 0)">Alle</option>
                            <option value="120" selected="@(_liters == 120)">120L</option>
                            <option value="240" selected="@(_liters == 240)">240L</option>
                            <option value="660" selected="@(_liters == 660)">660L</option>
                            <option value="1100" selected="@(_liters == 1100)">1100L</option>
                        </select>
                    </div>
                </div>

                <div class="mt-2 d-flex gap-2">
                    <button class="btn btn-sm btn-outline-secondary"
                            @onclick="ToggleShowOk">
                        @(_showOkCustomers ? "Skjul OK" : "Vis OK")
                    </button>

                    <button class="btn btn-sm btn-outline-secondary"
                            @onclick="ToggleSortMode">
                        Sort: @_sortMode
                    </button>
                </div>

                <div class="mt-3" style="max-height:70vh; overflow:auto;">
                    <table class="table table-sm table-hover align-middle mb-0">
                        <thead class="table-light sticky-top">
                            <tr>
                                <th style="width:80px;">Kunde</th>
                                <th>Navn</th>
                                <th class="text-end" style="width:60px;">L</th>
                                <th class="text-end" style="width:110px;">Under</th>
                                <th class="text-end" style="width:70px;">%</th>
                            </tr>
                        </thead>
                        <tbody>
                            @if (_customers == null || !_customers.Any())
                            {
                                <tr>
                                    <td colspan="5" class="text-muted">
                                        @_isLoading ? "Henter kunder..." : "Ingen kunder fundet."
                                    </td>
                                </tr>
                            }
                            else
                            {
                                @foreach (var c in FilteredCustomersV2)
                                {
                                    var selected =
                                        _selectedCustomer?.CustomerKey == c.CustomerKey &&
                                        _selectedCustomer?.Liters == c.Liters;

                                    <tr class="@(selected ? "table-primary" : "")"
                                        style="cursor:pointer"
                                        @onclick="() => SelectCustomer(c)">
                                        <td class="fw-semibold">@c.CustomerKey</td>
                                        <td>
                                            <div class="d-flex align-items-center justify-content-between">
                                                <span>@c.CustomerName</span>
                                                <span class="badge @ZoneBadgeClass(c.AvgFillPct)">
                                                    @ZoneLabel(c.AvgFillPct)
                                                </span>
                                            </div>
                                        </td>
                                        <td class="text-end">@c.Liters</td>
                                        <td class="text-end">@c.InefficientEmpties / @c.TotalEmpties</td>
                                        <td class="text-end">@c.InefficientPct.ToString("N1")%</td>
                                    </tr>
                                }
                            }
                        </tbody>
                    </table>

                    @if (string.IsNullOrWhiteSpace(_searchText))
                    {
                        <div class="text-muted small mt-2">
                            Viser top 100 efter “diagnose-sortering”. Brug søgning for at finde andre.
                        </div>
                    }
                </div>

            </div>
        </div>
    </div>

    <!-- HØJRE: Detaljer -->
    <div class="col-lg-8">
        <div class="card shadow-sm">
            <div class="card-body">

                @if (_selectedCustomer == null)
                {
                    <div class="text-muted">Vælg en kunde i listen.</div>
                }
                else if (_isLoadingDetails)
                {
                    <div>Henter detaljer...</div>
                }
                else if (_details == null)
                {
                    <div class="text-muted">Ingen detaljer at vise.</div>
                }
                else
                {
                    var d = _details;
                    var latest = LatestEmpty;
                    var isOk = d.AvgFillPct >= d.ThresholdPct;

                    <div class="d-flex justify-content-between align-items-start">
                        <div>
                            <h5 class="mb-1">@d.CustomerName</h5>
                            <div class="text-muted small">Kundenr: <b>@d.CustomerKey</b></div>
                        </div>

                        <span class="badge @(isOk ? "bg-success" : "bg-danger")">
                            @(isOk ? "OK" : "For lav fyldning")
                        </span>
                    </div>

                    <!-- TOP KPI -->
                    <div class="row g-2 mt-3">
                        <div class="col-md-3">
                            <div class="border rounded p-2">
                                <div class="text-muted small">Kapacitet</div>
                                <div class="fw-semibold">@d.CapacityKg.ToString("N1") kg</div>
                                <div class="text-muted small">@($"{d.Liters}L × 0,13")</div>
                            </div>
                        </div>

                        <div class="col-md-3">
                            <div class="border rounded p-2">
                                <div class="text-muted small">Grænse</div>
                                <div class="fw-semibold">@d.ThresholdPct%</div>
                                <div class="text-muted small">Under = ineffektiv</div>
                            </div>
                        </div>

                        <div class="col-md-3">
                            <div class="border rounded p-2">
                                <div class="text-muted small">Ineffektiv</div>
                                <div class="fw-semibold">@d.InefficientPct.ToString("N1")%</div>
                                <div class="text-muted small">@d.InefficientEmpties / @d.TotalEmpties</div>
                            </div>
                        </div>

                        <div class="col-md-3">
                            <div class="border rounded p-2">
                                <div class="text-muted small">Gns. fyldning</div>
                                <div class="fw-semibold">@d.AvgFillPct.ToString("N1")%</div>

                                @if (latest != null)
                                {
                                    <div class="text-muted small">
                                        Seneste: @latest.Date.ToString("yyyy-MM-dd") (@latest.FillPct.ToString("N1")%)
                                    </div>
                                }
                            </div>
                        </div>
                    </div>

                    <!-- VISUELT OVERBLIK -->
                    <div class="row g-3 mt-3">
                        <div class="col-md-4">
                            <div class="border rounded p-2">
                                <div class="text-muted small mb-2">Under/over grænse</div>
                                <DonutChart Value="@d.InefficientPct" Label="Ineffektiv" />
                                <div class="text-muted small mt-2">
                                    Tip: Brug månedsoversigten til at se om problemet er stabilt.
                                </div>
                            </div>
                        </div>

                        <div class="col-md-8">
                            <div class="border rounded p-2">
                                <div class="text-muted small mb-2">Fyldningsfordeling</div>
                                <FillHistogram Empties="@d.Empties" ThresholdPct="@d.ThresholdPct" />
                                <div class="text-muted small mt-2">
                                    Grøn = over grænse. Gul = gråzone. Rød = kritisk lav.
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- ✅ V2: MÅNEDSOVERSIGT = HOVEDSIGNAL -->
                    <div class="border rounded p-2 mt-3">
                        <div class="d-flex justify-content-between align-items-center">
                            <div class="text-muted small">Månedsoversigt (stabilitet)</div>
                            <div class="text-muted small">(under grænse = &lt; @d.ThresholdPct%)</div>
                        </div>

                        <div class="table-responsive mt-2">
                            <table class="table table-sm align-middle mb-0">
                                <thead class="table-light">
                                    <tr>
                                        <th style="width:90px;">Måned</th>
                                        <th class="text-end" style="width:90px;">Tømninger</th>
                                        <th class="text-end" style="width:140px;">Under grænse</th>
                                        <th class="text-end" style="width:100px;">Gns. fyld</th>
                                        <th style="width:120px;">Signal</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    @foreach (var m in MonthlyRows)
                                    {
                                        <tr>
                                            <td class="fw-semibold">@m.Month</td>
                                            <td class="text-end">@m.Count</td>
                                            <td class="text-end">@m.UnderCount (@m.UnderPct.ToString("N0")%)</td>
                                            <td class="text-end">@m.AvgFill.ToString("N1")%</td>
                                            <td>
                                                <span class="badge @m.BadgeClass">@m.BadgeLabel</span>
                                            </td>
                                        </tr>
                                    }
                                </tbody>
                            </table>
                        </div>

                        <div class="text-muted small mt-2">
                            Signal: <b>Rød</b> = stabilt lav fyldning • <b>Gul</b> = svinger/gråzone • <b>Grøn</b> = OK
                        </div>
                    </div>

                    <!-- ✅ V2: RÅ LISTE = COLLAPSIBLE -->
                    <div class="d-flex justify-content-between align-items-center mt-3">
                        <h6 class="mb-0">Seneste tømninger</h6>
                        <button class="btn btn-sm btn-outline-secondary" @onclick="ToggleShowAllEmpties">
                            @(_showAllEmpties ? "Vis færre" : "Vis alle")
                        </button>
                    </div>

                    <div class="text-muted small mb-2">
                        Tip: listen her er “rå data” – brug månedsoversigten til mønstre.
                    </div>

                    <div style="max-height:40vh; overflow:auto;">
                        @foreach (var e in VisibleEmpties)
                        {
                            var zoneClass = FillClass(e.FillPct, d.ThresholdPct);

                            <div class="mb-2">
                                <div class="d-flex justify-content-between small">
                                    <span class="text-muted">@e.Date.ToString("yyyy-MM-dd")</span>
                                    <span class="fw-semibold">
                                        @e.WeightKg.ToString("N1") kg
                                        <span class="text-muted">(@e.FillPct.ToString("N1")%)</span>
                                    </span>
                                </div>

                                <div class="progress" style="height:10px;">
                                    <div class="progress-bar @zoneClass"
                                         style="width:@Math.Clamp(e.FillPct, 0, 150)%">
                                    </div>
                                </div>
                            </div>
                        }
                    </div>
                }

            </div>
        </div>
    </div>
</div>

@code {
    private List<ContainerEfficiencyCustomerSummaryDto>? _customers;
    private ContainerEfficiencyCustomerSummaryDto? _selectedCustomer;
    private ContainerEfficiencyCustomerDetailDto? _details;

    private string? _error;
    private int _months = 12;
    private int _thresholdPct = 80;
    private int _liters = 0;
    private string _searchText = "";

    private bool _isLoading;
    private bool _isLoadingDetails;

    // V2 UI state
    private bool _showAllEmpties = false;
    private bool _showOkCustomers = false;
    private string _sortMode = "Kritisk først"; // "Kritisk først" -> "Gråzone først" -> "OK først"

    protected override async Task OnInitializedAsync()
        => await LoadSummaries();

    // ---------------------------
    // V2: KUNDER LISTE (smart sort)
    // ---------------------------
    private IEnumerable<ContainerEfficiencyCustomerSummaryDto> FilteredCustomersV2
    {
        get
        {
            var src = _customers ?? Enumerable.Empty<ContainerEfficiencyCustomerSummaryDto>();

            // søgning: vis alle matches
            if (!string.IsNullOrWhiteSpace(_searchText))
            {
                return src.Where(c =>
                    (c.CustomerName ?? "").Contains(_searchText, StringComparison.OrdinalIgnoreCase)
                    || c.CustomerKey.ToString().Contains(_searchText));
            }

            // uden søgning: brug diagnose-sortering
            var q = src;

            if (!_showOkCustomers)
            {
                // skjul de helt “OK” for at få bedre overblik
                q = q.Where(c => c.AvgFillPct < _thresholdPct);
            }

            // score = kombiner “hvor lav fyldning” + “hvor ofte under grænse”
            // lav fyldning vægtes højere end pct under grænse, fordi det siger mere om behovet.
            double Score(ContainerEfficiencyCustomerSummaryDto c)
            {
                var lowFill = Math.Max(0, _thresholdPct - c.AvgFillPct);      // hvor langt under grænse i pct-point
                var underShare = c.InefficientPct;                            // % under
                var fewDataPenalty = c.TotalEmpties < 8 ? 20 : 0;             // små datamængder = mindre sikker
                return lowFill * 2.0 + underShare * 0.8 - fewDataPenalty;
            }

            // bucket for sort mode
            int Bucket(ContainerEfficiencyCustomerSummaryDto c)
            {
                // zoner baseret på avg fill (hurtigt forståeligt)
                if (c.AvgFillPct < 60) return 0;              // kritisk
                if (c.AvgFillPct < _thresholdPct) return 1;   // gråzone/under grænse
                return 2;                                      // OK
            }

            // sortering
            IEnumerable<ContainerEfficiencyCustomerSummaryDto> sorted = _sortMode switch
            {
                "OK først" => q.OrderByDescending(Bucket).ThenBy(Score),
                "Gråzone først" => q.OrderBy(c => Bucket(c) == 1 ? 0 : Bucket(c)).ThenByDescending(Score),
                _ => q.OrderBy(Bucket).ThenByDescending(Score) // Kritisk først
            };

            return sorted.Take(100);
        }
    }

    private void ToggleShowAllEmpties() => _showAllEmpties = !_showAllEmpties;

    private void ToggleShowOk() => _showOkCustomers = !_showOkCustomers;

    private void ToggleSortMode()
    {
        _sortMode = _sortMode switch
        {
            "Kritisk først" => "Gråzone først",
            "Gråzone først" => "OK først",
            _ => "Kritisk først"
        };
    }

    // ---------------------------
    // Details helpers
    // ---------------------------
    private ContainerEmptyingDto? LatestEmpty =>
        _details?.Empties?.OrderByDescending(x => x.Date).FirstOrDefault();

    private IEnumerable<ContainerEmptyingDto> VisibleEmpties
    {
        get
        {
            var empties = _details?.Empties ?? new List<ContainerEmptyingDto>();
            var sorted = empties.OrderByDescending(x => x.Date);
            return _showAllEmpties ? sorted : sorted.Take(10);
        }
    }

    // Månedsoversigt rows
    private IEnumerable<MonthRow> MonthlyRows
    {
        get
        {
            if (_details?.Empties == null || _details.Empties.Count == 0)
                return Enumerable.Empty<MonthRow>();

            var thr = _details.ThresholdPct;

            return _details.Empties
                .GroupBy(e => e.Date.ToString("yyyy-MM", CultureInfo.InvariantCulture))
                .OrderByDescending(g => g.Key)
                .Select(g =>
                {
                    var count = g.Count();
                    var underCount = g.Count(x => x.FillPct < thr);
                    var underPct = count == 0 ? 0 : (underCount * 100.0 / count);
                    var avgFill = g.Average(x => x.FillPct);

                    // Signal: rød hvis >80% under, gul hvis 40-80%, grøn ellers
                    string badgeClass;
                    string badgeLabel;

                    if (underPct >= 80 || avgFill < 60)
                    {
                        badgeClass = "bg-danger";
                        badgeLabel = "Kritisk";
                    }
                    else if (underPct >= 40 || avgFill < thr)
                    {
                        badgeClass = "bg-warning text-dark";
                        badgeLabel = "Gråzone";
                    }
                    else
                    {
                        badgeClass = "bg-success";
                        badgeLabel = "OK";
                    }

                    return new MonthRow(g.Key, count, underCount, underPct, avgFill, badgeClass, badgeLabel);
                })
                .ToList();
        }
    }

    private sealed record MonthRow(
        string Month,
        int Count,
        int UnderCount,
        double UnderPct,
        double AvgFill,
        string BadgeClass,
        string BadgeLabel
    );

    // zoner (bruges til badges/progress)
    private static string ZoneLabel(float avgFillPct) =>
        avgFillPct < 60 ? "Kritisk" :
        avgFillPct < 80 ? "Gråzone" :
        "OK";

    private static string ZoneBadgeClass(float avgFillPct) =>
        avgFillPct < 60 ? "bg-danger" :
        avgFillPct < 80 ? "bg-warning text-dark" :
        "bg-success";

    private static string FillClass(float fillPct, int thresholdPct) =>
        fillPct < 60 ? "bg-danger" :
        fillPct < thresholdPct ? "bg-warning" :
        "bg-success";

    // ---------------------------
    // Data loading (uændret)
    // ---------------------------
    private async Task LoadSummaries()
    {
        _isLoading = true;
        _error = null;

        try
        {
            var url = _liters == 0
                ? $"api/stena/efficiency/summary/all?months={_months}&thresholdPct={_thresholdPct}"
                : $"api/stena/efficiency/summary?months={_months}&thresholdPct={_thresholdPct}&liters={_liters}";

            var response = await Http.GetAsync(url);
            var body = await response.Content.ReadAsStringAsync();

            _customers = JsonSerializer.Deserialize<List<ContainerEfficiencyCustomerSummaryDto>>(body,
                new JsonSerializerOptions { PropertyNameCaseInsensitive = true });

            _selectedCustomer = _customers?.FirstOrDefault();
            _details = null;

            if (_selectedCustomer != null)
                await LoadDetails(_selectedCustomer.CustomerKey, _selectedCustomer.Liters);
        }
        catch (Exception ex)
        {
            _error = ex.Message;
        }
        finally
        {
            _isLoading = false;
        }
    }

    private async Task LoadDetails(int customerKey, int liters)
    {
        _isLoadingDetails = true;

        try
        {
            var url = $"api/stena/efficiency/customer/{customerKey}?months={_months}&thresholdPct={_thresholdPct}&liters={liters}";
            var response = await Http.GetAsync(url);
            var body = await response.Content.ReadAsStringAsync();

            _details = JsonSerializer.Deserialize<ContainerEfficiencyCustomerDetailDto>(body,
                new JsonSerializerOptions { PropertyNameCaseInsensitive = true });

            // reset raw list state når man skifter kunde
            _showAllEmpties = false;
        }
        catch (Exception ex)
        {
            _error = ex.Message;
        }
        finally
        {
            _isLoadingDetails = false;
        }
    }

    private async Task SelectCustomer(ContainerEfficiencyCustomerSummaryDto c)
    {
        if (_selectedCustomer?.CustomerKey == c.CustomerKey &&
            _selectedCustomer?.Liters == c.Liters)
            return;

        _selectedCustomer = c;
        await LoadDetails(c.CustomerKey, c.Liters);
    }

    private async Task OnMonthsChanged(ChangeEventArgs e)
    {
        _months = int.Parse(e.Value!.ToString()!);
        await LoadSummaries();
    }

    private async Task OnThresholdChanged(ChangeEventArgs e)
    {
        _thresholdPct = int.Parse(e.Value!.ToString()!);
        await LoadSummaries();
    }

    private async Task OnLitersChanged(ChangeEventArgs e)
    {
        _liters = int.Parse(e.Value!.ToString()!);
        await LoadSummaries();
    }
}
