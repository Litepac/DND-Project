@page "/container-efficiency"

@using System.Text.Json
@using DNDProject.Web.Models
@inject HttpClient Http

<h3 class="mb-3">Kunde – tømningsanalyse (660 L container)</h3>

@if (!string.IsNullOrWhiteSpace(_error))
{
    <div class="alert alert-danger">@_error</div>
}

<div class="row g-3">

    <!-- VENSTRE: Kunder -->
    <div class="col-lg-4">
        <div class="card shadow-sm">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-start">
                    <div>
                        <h5 class="card-title mb-1">Alle kunder</h5>
                        <div class="text-muted small">Andel af tømninger under grænsen.</div>
                    </div>
                </div>

                <div class="row g-2 mt-3">
                    <div class="col-7">
                        <input class="form-control form-control-sm"
                               placeholder="Søg navn eller kundenr..."
                               @bind="_searchText" />
                    </div>
                    <div class="col-3">
                        <select class="form-select form-select-sm" @onchange="OnMonthsChanged">
                            <option value="3" selected="@(_months == 3)">3 mdr</option>
                            <option value="6" selected="@(_months == 6)">6 mdr</option>
                            <option value="12" selected="@(_months == 12)">12 mdr</option>
                            <option value="24" selected="@(_months == 24)">24 mdr</option>
                        </select>
                    </div>
                    <div class="col-2">
                        <select class="form-select form-select-sm" @onchange="OnThresholdChanged">
                            <option value="70" selected="@(_thresholdPct == 70)">70%</option>
                            <option value="75" selected="@(_thresholdPct == 75)">75%</option>
                            <option value="80" selected="@(_thresholdPct == 80)">80%</option>
                            <option value="85" selected="@(_thresholdPct == 85)">85%</option>
                        </select>
                    </div>
                </div>

                <div class="mt-3" style="max-height: 70vh; overflow:auto;">
                    <table class="table table-sm table-hover align-middle mb-0">
                        <thead class="table-light sticky-top">
                            <tr>
                                <th style="width:80px;">Kunde</th>
                                <th>Navn</th>
                                <th class="text-end" style="width:110px;">Ineff.</th>
                                <th class="text-end" style="width:70px;">%</th>
                            </tr>
                        </thead>
                        <tbody>
                            @if (_customers is null || !_customers.Any())
                            {
                                <tr>
                                    <td colspan="4" class="text-muted">
                                        @_isLoading ? "Henter kunder..." : "Ingen kunder fundet."
                                    </td>
                                </tr>
                            }
                            else
                            {
                                @foreach (var c in FilteredCustomers)
                                {
                                    var selected = _selectedCustomer?.LevNr == c.LevNr;
                                    <tr class="@(selected ? "table-primary" : "")"
                                        style="cursor:pointer"
                                        @onclick="() => SelectCustomer(c)">
                                        <td class="fw-semibold">@c.LevNr</td>
                                        <td>@c.CustomerName</td>
                                        <td class="text-end">@c.InefficientEmpties / @c.TotalEmpties</td>
                                        <td class="text-end">@c.InefficientPct.ToString("N1")%</td>
                                    </tr>
                                }

                                if (!FilteredCustomers.Any())
                                {
                                    <tr>
                                        <td colspan="4" class="text-muted">Ingen match.</td>
                                    </tr>
                                }
                            }
                        </tbody>
                    </table>
                </div>

            </div>
        </div>
    </div>

    <!-- HØJRE: Detaljer -->
    <div class="col-lg-8">
        <div class="card shadow-sm">
            <div class="card-body">

                @if (_selectedCustomer is null)
                {
                    <div class="text-muted">Vælg en kunde i listen.</div>
                }
                else if (_isLoadingDetails)
                {
                    <div>Henter detaljer...</div>
                }
                else if (_details is null)
                {
                    <div class="text-muted">Ingen detaljer at vise.</div>
                }
                else
                {
                    var d = _details;
                    var isOk = d.AvgFillPct >= d.ThresholdPct;

                    <div class="d-flex justify-content-between align-items-start">
                        <div>
                            <h5 class="mb-1">@d.CustomerName</h5>
                            <div class="text-muted small">Kundenr: <span class="fw-semibold">@d.LevNr</span></div>
                        </div>
                        <div>
                            <span class="badge @(isOk ? "bg-success" : "bg-danger")">
                                @(isOk ? "OK" : "For lav fyldning")
                            </span>
                        </div>
                    </div>

                    <div class="row g-2 mt-3">
                        <div class="col-md-3">
                            <div class="border rounded p-2">
                                <div class="text-muted small">Kapacitet</div>
                                <div class="fw-semibold">@d.CapacityKg.ToString("N1") kg</div>
                                <div class="text-muted small">660L × 0,13</div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="border rounded p-2">
                                <div class="text-muted small">Grænse</div>
                                <div class="fw-semibold">@d.ThresholdPct%</div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="border rounded p-2">
                                <div class="text-muted small">Ineffektiv</div>
                                <div class="fw-semibold">@d.InefficientPct.ToString("N1")%</div>
                                <div class="text-muted small">@d.InefficientEmpties / @d.TotalEmpties</div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="border rounded p-2">
                                <div class="text-muted small">Gns. fyldning</div>
                                <div class="fw-semibold">@d.AvgFillPct.ToString("N1")%</div>
                            </div>
                        </div>
                    </div>

                    <hr class="my-3" />

                    <div class="d-flex justify-content-between align-items-center">
                        <h6 class="mb-0">Seneste tømninger</h6>
                        <div class="text-muted small">Viser op til 50</div>
                    </div>

                    @if (d.Empties is null || !d.Empties.Any())
                    {
                        <p class="text-muted mt-2">Ingen tømninger i perioden.</p>
                    }
                    else
                    {
                        <div class="mt-2" style="max-height: 60vh; overflow:auto;">
                            @foreach (var e in d.Empties)
                            {
                                var bad = e.FillPct < d.ThresholdPct;
                                <div class="mb-2">
                                    <div class="d-flex justify-content-between small">
                                        <span class="text-muted">@e.KoeresDato.ToString("yyyy-MM-dd")</span>
                                        <span class="fw-semibold">
                                            @e.WeightKg.ToString("N1") kg
                                            <span class="text-muted">(@e.FillPct.ToString("N1")%)</span>
                                        </span>
                                    </div>
                                    <div class="progress" style="height: 10px;">
                                        <div class="progress-bar @(bad ? "bg-danger" : "bg-success")"
                                             style="width:@Math.Clamp(e.FillPct, 0, 150)%">
                                        </div>
                                    </div>
                                </div>
                            }
                        </div>
                    }
                }

            </div>
        </div>
    </div>

</div>

@code {
    private List<ContainerEfficiencyCustomerSummaryDto>? _customers;
    private ContainerEfficiencyCustomerSummaryDto? _selectedCustomer;
    private ContainerEfficiencyCustomerDetailDto? _details;

    private string? _error;
    private int _months = 12;
    private int _thresholdPct = 80;
    private string _searchText = "";

    private bool _isLoading = false;
    private bool _isLoadingDetails = false;

    private IEnumerable<ContainerEfficiencyCustomerSummaryDto> FilteredCustomers =>
        string.IsNullOrWhiteSpace(_searchText)
            ? _customers ?? Enumerable.Empty<ContainerEfficiencyCustomerSummaryDto>()
            : (_customers ?? Enumerable.Empty<ContainerEfficiencyCustomerSummaryDto>())
                .Where(c =>
                    (c.CustomerName ?? "").Contains(_searchText, StringComparison.OrdinalIgnoreCase)
                    || c.LevNr.ToString().Contains(_searchText));

    protected override async Task OnInitializedAsync()
        => await LoadSummaries();

    private async Task LoadSummaries()
    {
        _error = null;
        _isLoading = true;

        try
        {
            var url = $"api/stena/efficiency/summary?months={_months}&thresholdPct={_thresholdPct}";
            var response = await Http.GetAsync(url);
            var body = await response.Content.ReadAsStringAsync();

            if (!response.IsSuccessStatusCode)
            {
                _customers = new();
                _selectedCustomer = null;
                _details = null;
                _error = $"API-fejl ({(int)response.StatusCode}): {body}";
                return;
            }

            _customers = string.IsNullOrWhiteSpace(body)
                ? new List<ContainerEfficiencyCustomerSummaryDto>()
                : JsonSerializer.Deserialize<List<ContainerEfficiencyCustomerSummaryDto>>(
                      body,
                      new JsonSerializerOptions { PropertyNameCaseInsensitive = true }
                  ) ?? new List<ContainerEfficiencyCustomerSummaryDto>();

            _selectedCustomer = _customers.FirstOrDefault();
            _details = null;

            if (_selectedCustomer != null)
                await LoadDetails(_selectedCustomer.LevNr);
        }
        catch (Exception ex)
        {
            _error = $"Kunne ikke hente kundeliste: {ex.Message}";
        }
        finally
        {
            _isLoading = false;
        }
    }

    private async Task LoadDetails(int levNr)
    {
        _error = null;
        _isLoadingDetails = true;

        try
        {
            var url = $"api/stena/efficiency/customer/{levNr}?months={_months}&thresholdPct={_thresholdPct}";
            var response = await Http.GetAsync(url);
            var body = await response.Content.ReadAsStringAsync();

            if (!response.IsSuccessStatusCode)
            {
                _details = null;
                _error = $"Kunne ikke hente detaljer ({(int)response.StatusCode}): {body}";
                return;
            }

            _details = string.IsNullOrWhiteSpace(body)
                ? null
                : JsonSerializer.Deserialize<ContainerEfficiencyCustomerDetailDto>(
                      body,
                      new JsonSerializerOptions { PropertyNameCaseInsensitive = true }
                  );

            if (_details != null)
                _details.ThresholdPct = _thresholdPct;
        }
        catch (Exception ex)
        {
            _details = null;
            _error = $"Kunne ikke hente detaljer: {ex.Message}";
        }
        finally
        {
            _isLoadingDetails = false;
        }
    }

    private async Task SelectCustomer(ContainerEfficiencyCustomerSummaryDto c)
    {
        if (_selectedCustomer?.LevNr == c.LevNr)
            return;

        _selectedCustomer = c;
        _details = null;
        await LoadDetails(c.LevNr);
    }

    private async Task OnMonthsChanged(ChangeEventArgs e)
    {
        if (int.TryParse(e.Value?.ToString(), out var m))
        {
            _months = m;
            await LoadSummaries();
        }
    }

    private async Task OnThresholdChanged(ChangeEventArgs e)
    {
        if (int.TryParse(e.Value?.ToString(), out var t))
        {
            _thresholdPct = t;
            await LoadSummaries();
        }
    }
}
