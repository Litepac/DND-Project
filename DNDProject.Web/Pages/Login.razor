@page "/login"
@using System.Net.Http.Json
@using DNDProject.Web.Auth
@inject HttpClient Http
@inject JwtAuthStateProvider AuthState
@inject NavigationManager Nav

<h3>Login</h3>

@if (!string.IsNullOrWhiteSpace(error))
{
    <div class="alert alert-danger">@error</div>
}

<EditForm Model="@model" OnValidSubmit="@HandleLogin">
    <DataAnnotationsValidator />
    <ValidationSummary />

    <div class="mb-3">
        <label>Email</label>
        <InputText class="form-control" @bind-Value="model.Email" />
    </div>

    <div class="mb-3">
        <label>Password</label>
        <InputText class="form-control" Type="password" @bind-Value="model.Password" />
    </div>

    <button class="btn btn-primary" disabled="@busy">Log ind</button>
    <button type="button" class="btn btn-outline-secondary ms-2" @onclick="Logout" disabled="@busy">Log ud</button>
</EditForm>

@code {
    bool busy;
    string? error;

    LoginRequest model = new() { Email = "admin@demo.local", Password = "Pass123!" };

    class LoginRequest
    {
        public string Email { get; set; } = "";
        public string Password { get; set; } = "";
    }

    record LoginResponse(string Token, DateTime Expires, string Email, IEnumerable<string> Roles, int? CustomerId);

    async Task HandleLogin()
    {
        error = null;
        busy = true;

        try
        {
            var resp = await Http.PostAsJsonAsync("api/auth/login", model);
            if (!resp.IsSuccessStatusCode)
            {
                error = $"Login fejlede ({(int)resp.StatusCode})";
                return;
            }

            var dto = await resp.Content.ReadFromJsonAsync<LoginResponse>();
            if (dto is null || string.IsNullOrWhiteSpace(dto.Token))
            {
                error = "Kunne ikke læse token fra serveren.";
                return;
            }

            // Gem token + opdater Blazor auth-state
            await AuthState.MarkUserAsAuthenticatedAsync(dto.Token);

            // Efter login -> gå til forsiden (/home)
            Nav.NavigateTo("/home", replace: true);
        }
        catch (Exception ex)
        {
            error = ex.Message;
        }
        finally
        {
            busy = false;
        }
    }

    async Task Logout()
    {
        await AuthState.MarkUserAsLoggedOutAsync();
        Nav.NavigateTo("/login", replace: true);
    }
}
