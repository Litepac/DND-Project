@using System.Security.Claims
@using Microsoft.AspNetCore.Components.Authorization
@using DNDProject.Web.Auth
@inject AuthenticationStateProvider Auth
@inject JwtAuthStateProvider AuthState
@inject NavigationManager Nav

<div class="top-row ps-3 navbar navbar-dark">
    <div class="container-fluid d-flex align-items-center gap-2">
        <img src="images/stena-logo.png" alt="Stena" style="height:28px;" />
        <span class="navbar-brand mb-0" style="font-weight:700;">Stena Smart Collection</span>

        <button title="Navigation menu" class="navbar-toggler ms-auto" @onclick="ToggleNavMenu">
            <span class="navbar-toggler-icon"></span>
        </button>
    </div>
</div>

<div class="@NavMenuCssClass nav-scrollable">
    <nav class="nav flex-column">

        @if (!string.IsNullOrWhiteSpace(email))
        {
            <div class="px-3 py-3"
                 style="color: rgba(255,255,255,.85); border-bottom: 1px solid rgba(255,255,255,.12);">
                <div style="font-size:.9rem; font-weight:600;">@email</div>
                @if (roles?.Count > 0)
                {
                    <div style="font-size:.8rem; opacity:.8;">@string.Join(" • ", roles)</div>
                }
            </div>
        }

        <div class="nav-item px-3 pt-2">
            <NavLink class="nav-link" href="home" Match="NavLinkMatch.All">
                <span class="bi bi-house" aria-hidden="true"></span> Forside
            </NavLink>
        </div>

        <div class="nav-item px-3 pt-2">
            <NavLink class="nav-link" href="customer-dashboard">
                <span class="bi bi-graph-up" aria-hidden="true"></span> Kunde-dashboard
            </NavLink>
        </div>

        <div class="nav-item px-3">
            <NavLink class="nav-link" href="container-efficiency">
                <span class="bi bi-bar-chart-line" aria-hidden="true"></span> Tømningsanalyse
            </NavLink>
        </div>

        <div class="nav-item px-3">
            <NavLink class="nav-link" href="ml-customers">
                <span class="bi bi-graph-up" aria-hidden="true"></span> ML – Top kunder
            </NavLink>
        </div>

        <div class="nav-item px-3 mt-3">
            <button type="button" class="btn btn-outline-light w-100" @onclick="Logout">
                <span class="bi bi-box-arrow-right" aria-hidden="true"></span> Log ud
            </button>
        </div>

    </nav>
</div>

@code {
    private bool collapseNavMenu = true;
    private string? NavMenuCssClass => collapseNavMenu ? "collapse" : null;
    private void ToggleNavMenu() => collapseNavMenu = !collapseNavMenu;

    string? email;
    List<string> roles = new();

    protected override async Task OnInitializedAsync()
    {
        await LoadUserInfoAsync();

        Auth.AuthenticationStateChanged += async task =>
        {
            await LoadUserInfoAsync(task);
            await InvokeAsync(StateHasChanged);
        };
    }

    private async Task LoadUserInfoAsync(Task<AuthenticationState>? task = null)
    {
        var state = task is null ? await Auth.GetAuthenticationStateAsync() : await task;
        var user = state.User;

        email = user?.Identity?.Name;

        roles = user?.Claims
            .Where(c => c.Type == ClaimTypes.Role)
            .Select(c => c.Value)
            .Distinct()
            .ToList() ?? new List<string>();
    }

    private async Task Logout()
    {
        await AuthState.MarkUserAsLoggedOutAsync();
        Nav.NavigateTo("/login", replace: true);
    }
}
