@using Microsoft.AspNetCore.Components.Authorization
@inject AuthenticationStateProvider Auth
@inject NavigationManager Nav

@if (_allowed)
{
    @ChildContent
}

@code {
    [Parameter] public RenderFragment? ChildContent { get; set; }

    private bool _allowed;

    protected override async Task OnInitializedAsync()
    {
        var path = Nav.ToBaseRelativePath(Nav.Uri).Trim('/');

        // login er public
        if (string.Equals(path, "login", StringComparison.OrdinalIgnoreCase))
        {
            _allowed = true;
            return;
        }

        var state = await Auth.GetAuthenticationStateAsync();
        var ok = state.User?.Identity?.IsAuthenticated == true;

        if (!ok)
        {
            Nav.NavigateTo("/login", replace: true);
            return;
        }

        _allowed = true;
    }

    protected override async Task OnParametersSetAsync()
    {
        // Hvis du navigerer mellem sider mens du er logget ind, skal den ikke “låse”
        if (_allowed) return;

        var path = Nav.ToBaseRelativePath(Nav.Uri).Trim('/');

        if (string.Equals(path, "login", StringComparison.OrdinalIgnoreCase))
        {
            _allowed = true;
            return;
        }

        var state = await Auth.GetAuthenticationStateAsync();
        if (state.User?.Identity?.IsAuthenticated == true)
            _allowed = true;
    }
}
